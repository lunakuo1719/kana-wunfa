<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>文法討伐團~捏！</title>
    <style>
        :root {
            --kanahei-pink: #fce4ec; 
            --kanahei-rose: #f06292; 
            --kanahei-brown: #6d4c41; 
            --kanahei-cream: #fff9c4; 
        }

        * { box-sizing: border-box; font-family: 'Arial', sans-serif; font-weight: 900; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; padding: 10px; background-color: var(--kanahei-pink); 
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; overflow-y: auto; 
        }

        .card {
            width: 100%; max-width: 500px; background: white;
            border: 5px solid var(--kanahei-brown);
            border-radius: 35px; padding: 15px;
            box-shadow: 0px 8px 0px var(--kanahei-rose);
            position: relative; text-align: center;
            margin-top: 10px;
        }

        /* 返回鍵樣式 */
        .back-btn {
            position: absolute; top: 15px; left: 15px;
            width: 45px; height: 45px; cursor: pointer; z-index: 100;
        }

        .header-gifs { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .header-gifs img { width: 30%; height: auto; }
        .header-gifs img:nth-child(2) { width: 36%; transform: translateY(-5px); }

        #feedback-overlay {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 999; display: none; pointer-events: none;
        }
        #feedback-overlay img { width: 180px; filter: drop-shadow(0 0 10px white); }

        #win-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(255, 255, 255, 0.9);
            display: none; flex-direction: column; justify-content: center;
            align-items: center; z-index: 1000;
        }
        #win-overlay img { width: 80%; max-width: 300px; }

        .progress-info { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; color: var(--kanahei-brown); padding: 0 5px; }
        .progress-container { margin-bottom: 15px; position: relative; height: 45px; }
        .piske-runner { position: absolute; bottom: 8px; width: 50px; transition: left 0.3s; margin-left: -25px; }
        .bar-outer { height: 12px; background: var(--kanahei-cream); border: 2px solid var(--kanahei-brown); border-radius: 10px; overflow: hidden; }
        .bar-inner { height: 100%; width: 0%; background: var(--kanahei-rose); transition: width 0.3s; }

        .q-box { font-size: 20px; color: var(--kanahei-brown); margin: 10px 0; text-align: left; line-height: 1.3; padding: 0 5px; }
        
        .btn-choice { 
            background: white; margin-bottom: 10px; font-size: 19px; 
            border: 3px solid var(--kanahei-brown); border-radius: 15px; 
            width: 100%; padding: 12px; text-align: left; cursor: pointer; color: var(--kanahei-brown);
            box-shadow: 0 4px 0 #ddd; transition: 0.2s;
        }

        /* 答錯時顯示正確答案的樣式 */
        .btn-correct-reveal {
            background-color: var(--kanahei-rose) !important;
            color: white !important;
            border-color: var(--kanahei-brown) !important;
        }
        /* 答錯時點選錯誤的樣式 */
        .btn-wrong-select {
            background-color: #eee !important;
            color: #aaa !important;
            box-shadow: none !important;
        }

        .main-btn { 
            width: 90%; padding: 15px; font-size: 22px; border-radius: 30px; 
            background: var(--kanahei-rose); color: white; border: 4px solid var(--kanahei-brown); 
            cursor: pointer; box-shadow: 0 5px 0 var(--kanahei-brown); margin: 8px 0;
        }

        .translation-box { 
            background: #fff9c4; padding: 15px; border-radius: 20px; 
            margin-top: 10px; font-size: 17px; border: 3px dashed var(--kanahei-rose); 
            color: #d81b60; text-align: left;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="feedback-overlay"><img id="feedback-img" src=""></div>

<div id="win-overlay" onclick="location.reload()">
    <img src="https://lunakuo1719.github.io/kana-wunfa/nahappy.gif">
    <h1 style="color: var(--kanahei-rose);">攻略成功！捏！</h1>
    <p>點擊畫面回到首頁</p>
</div>

<div class="card">
    <img id="back-home" src="https://lunakuo1719.github.io/kana-wunfa/back_01.png" class="back-btn hidden" onclick="location.reload()">

    <div id="dashboard">
        <div class="header-gifs">
            <img src="https://lunakuo1719.github.io/kana-wunfa/heade-M.gif">
            <img src="https://lunakuo1719.github.io/kana-wunfa/xmas.gif">
            <img src="https://lunakuo1719.github.io/kana-wunfa/heade_r.gif">
        </div>
        <h1 style="color: var(--kanahei-rose); margin:5px 0; font-size: 26px;">文法討伐團~捏！</h1>
        
        <div style="background: var(--kanahei-cream); padding: 15px; border-radius: 25px; border: 3px solid var(--kanahei-brown); margin: 15px 0;">
            <p style="font-size:18px; margin:5px 0;">已熟練：<span id="mastered-count" style="color:var(--kanahei-rose)">0</span></p>
            <p style="font-size:18px; margin:5px 0;">錯題數：<span id="failed-count">0</span> | 貼紙：<span id="sticker-count">0</span>/17</p>
        </div>

        <button class="main-btn" onclick="startLevel()">開始討伐！</button>
        <button id="retry-btn" class="main-btn" style="background:#b2cecf; display:none;" onclick="startRetry()">錯題補考</button>
        <button class="main-btn" style="background:#ffd54f;" onclick="alert('收集冊即將開放！')">我的收集冊</button>
    </div>

    <div id="game-zone" class="hidden">
        <div class="progress-info" style="margin-top: 40px;"> <span>討伐進行中...</span>
            <span><span id="progress-num">0</span> / <span id="total-num">20</span></span>
        </div>
        <div class="progress-container">
            <img id="piske-img" src="https://lunakuo1719.github.io/kana-wunfa/giphy_haha.gif" class="piske-runner">
            <div class="bar-outer"><div class="bar-inner" id="progress-bar"></div></div>
        </div>
        
        <div id="q-text" class="q-box"></div>
        <div id="choices-area"></div>
        
        <div id="hint-area" class="translation-box hidden">
            <span id="hint-text"></span>
        </div>
    </div>
</div>

<script>
const IMG_YES = "https://lunakuo1719.github.io/kana-wunfa/heartna.gif";
const IMG_WRONG = "https://lunakuo1719.github.io/kana-wunfa/Wrong.gif";

// 題目數據保持不變...
const allQuestions = [
    { q: "This is _______ elephant.", opts: ["a", "an", "X", "the"], a: "an", note: "中文翻譯：這是一隻大象。" },
    { q: "I _______ a teacher.", opts: ["am", "is", "were", "be"], a: "am", note: "中文翻譯：我是一位老師。" },
    { q: "His sons _______ good boys.", opts: ["is", "are", "do", "have"], a: "are", note: "中文翻譯：他的兒子們是好男孩。" },
    { q: "They _______ cats.", opts: ["is am", "are", "be", "X"], a: "are", note: "中文翻譯：牠們是貓。" },
    { q: "The moon _______ yellow.", opts: ["was", "were", "is", "am"], a: "is", note: "中文翻譯：月亮是黃色的。" },
    { q: "They _______ students.", opts: ["is", "are", "be", "am"], a: "are", note: "中文翻譯：他們是學生。" },
    { q: "She _______ a doctor.", opts: ["do", "does", "are", "is"], a: "is", note: "中文翻譯：她是一位醫生。" },
    { q: "He _______ many books.", opts: ["is", "be", "have", "has"], a: "has", note: "中文翻譯：他有很多書。" },
    { q: "We _______ many pens.", opts: ["is", "be", "have", "has"], a: "have", note: "中文翻譯：我們有很多筆。" },
    { q: "A teacher works in a _______.", opts: ["school", "ship", "car", "train"], a: "school", note: "中文翻譯：老師在學校裡工作。" },
    { q: "They have _______ dogs.", opts: ["twelve", "a", "one", "an"], a: "twelve", note: "中文翻譯：他們有12隻狗。" },
    { q: "We like _______ daughters.", opts: ["our", "yours", "us", "you"], a: "our", note: "中文翻譯：我們喜歡我們的女兒們。" },
    { q: "_______ house is beautiful.", opts: ["I", "My", "Me", "Mine"], a: "My", note: "中文翻譯：我的房子是漂亮的。" },
    { q: "Banana is _______.", opts: ["red", "brown", "yellow", "blue"], a: "yellow", note: "中文翻譯：香蕉是黃色的。" },
    { q: "Trees are _______.", opts: ["pink", "red", "black", "green"], a: "green", note: "中文翻譯：樹是綠色的。" },
    { q: "I am _______ teacher.", opts: ["he", "me", "they", "his"], a: "his", note: "中文翻譯：我是他的老師。" },
    { q: "He is _______ teacher.", opts: ["mine", "my", "yours", "hers"], a: "my", note: "中文翻譯：他是我的老師。" },
    { q: "We are talking _______ the book.", opts: ["in", "about", "on", "under"], a: "about", note: "中文翻譯：我們正在說那本書。" },
    { q: "_______ can fly.", opts: ["Dogs", "Cats", "Birds", "Fish"], a: "Birds", note: "中文翻譯：鳥會飛。" },
    { q: "I drank _______ for breakfast.", opts: ["milk", "books", "theaters", "rabbits"], a: "milk", note: "中文翻譯：我喝牛奶當早餐。" },
    { q: "I have two _______.", opts: ["eyes", "nose", "mouth", "face"], a: "eyes", note: "中文翻譯：我有兩隻眼睛。" },
    { q: "He _______ three sisters.", opts: ["is", "are", "has", "have"], a: "has", note: "中文翻譯：他有三個姐妹。" },
    { q: "They _______ three brothers.", opts: ["is", "are", "has", "have"], a: "have", note: "中文翻譯：他們有三個兄弟。" },
    { q: "My father _______ a car.", opts: ["has", "have", "is", "are"], a: "has", note: "中文翻譯：我父親有一輛車。" },
    { q: "The boy _______ a kite.", opts: ["has", "have", "is", "are"], a: "has", note: "中文翻譯：男孩有一隻風箏。" },
    { q: "The boys _______ a kite.", opts: ["has", "have", "is", "are"], a: "have", note: "中文翻譯：男孩們有一隻風箏。" },
    { q: "A bird _______ two wings.", opts: ["has", "have", "is", "are"], a: "has", note: "中文翻譯：一隻鳥有兩隻翅膀。" },
    { q: "Birds _______ wings.", opts: ["has", "have", "is", "are"], a: "have", note: "中文翻譯：鳥有翅膀。" },
    { q: "He _______ my friend.", opts: ["is", "are", "am", "be"], a: "is", note: "中文翻譯：他是我的朋友。" },
    { q: "We _______ friends.", opts: ["is", "are", "am", "be"], a: "are", note: "中文翻譯：我們是朋友。" },
    { q: "I _______ hungry.", opts: ["is", "are", "am", "be"], a: "am", note: "中文翻譯：我餓了。" },
    { q: "The cats _______ hungry.", opts: ["is", "are", "am", "be"], a: "are", note: "中文翻譯：貓餓了。" },
    { q: "He _______ go to school.", opts: ["don't", "doesn't", "isn't", "aren't"], a: "doesn't", note: "中文翻譯：他不上學。" },
    { q: "They _______ go to school.", opts: ["don't", "doesn't", "isn't", "aren't"], a: "don't", note: "中文翻譯：他們不上學。" },
    { q: "He _______ like to play tennis.", opts: ["don't", "doesn't", "isn't", "aren't"], a: "doesn't", note: "中文翻譯：他不喜歡打網球。" },
    { q: "I _______ like to play tennis.", opts: ["don't", "doesn't", "isn't", "aren't"], a: "don't", note: "中文翻譯：我不喜歡打網球。" },
    { q: "We _______ like to play tennis.", opts: ["don't", "doesn't", "isn't", "aren't"], a: "don't", note: "中文翻譯：我們不喜歡打網球。" },
    { q: "The boy _______ like to play tennis.", opts: ["don't", "doesn't", "isn't", "aren't"], a: "doesn't", note: "中文翻譯：那個男孩不喜歡打網球。" },
    { q: "The boys _______ like to play tennis.", opts: ["don't", "doesn't", "isn't", "aren't"], a: "don't", note: "中文翻譯：那些男孩不喜歡打網球。" },
    { q: "It _______ rain in winter.", opts: ["don't", "doesn't", "isn't", "aren't"], a: "doesn't", note: "中文翻譯：冬天不下雨。" },
    { q: "He _______ very tall.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：他很高。" },
    { q: "They _______ very tall.", opts: ["am", "is", "are", "be"], a: "are", note: "中文翻譯：他們很高。" },
    { q: "I _______ a tall boy.", opts: ["am", "is", "are", "be"], a: "am", note: "中文翻譯：我是一個高個子的男孩。" },
    { q: "He _______ a tall boy.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：他是一個高個子的男孩。" },
    { q: "I _______ hot.", opts: ["am", "is", "are", "be"], a: "am", note: "中文翻譯：我很熱。" },
    { q: "He _______ hot.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：他很熱。" },
    { q: "They _______ hot.", opts: ["am", "is", "are", "be"], a: "are", note: "中文翻譯：他們很熱。" },
    { q: "I _______ thirsty.", opts: ["am", "is", "are", "be"], a: "am", note: "中文翻譯：我渴了。" },
    { q: "He _______ thirsty.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：他渴了。" },
    { q: "They _______ thirsty.", opts: ["am", "is", "are", "be"], a: "are", note: "中文翻譯：他們渴了。" },
    { q: "We _______ thirsty.", opts: ["am", "is", "are", "be"], a: "are", note: "中文翻譯：我們渴了。" },
    { q: "It _______ hot today.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：今天天氣熱。" },
    { q: "It _______ cold today.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：今天天氣冷。" },
    { q: "The water _______ cold.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：水是冷的。" },
    { q: "The flowers _______ beautiful.", opts: ["am", "is", "are", "be"], a: "are", note: "中文翻譯：花是漂亮的。" },
    { q: "The book _______ new.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：這本書是新的。" },
    { q: "The books _______ new.", opts: ["am", "is", "are", "be"], a: "are", note: "中文翻譯：這些書是新的。" },
    { q: "He _______ my brother.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：他是我的兄弟。" },
    { q: "They _______ my brothers.", opts: ["am", "is", "are", "be"], a: "are", note: "中文翻譯：他們是我的兄弟。" },
    { q: "She _______ my sister.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：她是我的姐妹。" },
    { q: "They _______ my sisters.", opts: ["am", "is", "are", "be"], a: "are", note: "中文翻譯：她們是我的姐妹。" },
    { q: "I _______ happy.", opts: ["am", "is", "are", "be"], a: "am", note: "中文翻譯：我很快樂。" },
    { q: "He _______ happy.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：他很快樂。" },
    { q: "They _______ happy.", opts: ["am", "is", "are", "be"], a: "are", note: "中文翻譯：他們很快樂。" },
    { q: "I _______ sad.", opts: ["am", "is", "are", "be"], a: "am", note: "中文翻譯：我很憂傷。" },
    { q: "He _______ sad.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：他很憂傷。" },
    { q: "They _______ sad.", opts: ["am", "is", "are", "be"], a: "are", note: "中文翻譯：他們很憂傷。" },
    { q: "I _______ thin.", opts: ["am", "is", "are", "be"], a: "am", note: "中文翻譯：我很瘦。" },
    { q: "He _______ thin.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：他很瘦。" },
    { q: "They _______ thin.", opts: ["am", "is", "are", "be"], a: "are", note: "中文翻譯：他們很瘦。" },
    { q: "I _______ fat.", opts: ["am", "is", "are", "be"], a: "am", note: "中文翻譯：我很胖。" },
    { q: "He _______ fat.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：他很胖。" },
    { q: "They _______ fat.", opts: ["am", "is", "are", "be"], a: "are", note: "中文翻譯：他們很胖。" },
    { q: "I _______ a student.", opts: ["am", "is", "are", "be"], a: "am", note: "中文翻譯：我是一個學生。" },
    { q: "He _______ a student.", opts: ["am", "is", "are", "be"], a: "is", note: "中文翻譯：他是一個學生。" },
    { q: "Choose the correct sentence:", opts: ["I like to play the piano.", "I like play the piano.", "I am like to play the piano.", "I like playing the piano."], a: "I like to play the piano.", note: "1-1：like 後接 to V 或 Ving [cite: 2, 38]。" },
    { q: "Choose the correct sentence:", opts: ["He swim every day.", "He swims every day.", "He is swim every day.", "He swimming every day."], a: "He swims every day.", note: "1-2：第三人稱單數習慣性動作，動詞加 s [cite: 2, 42]。" },
    { q: "Choose the correct sentence:", opts: ["I not his student.", "I am not his student.", "I don't his student.", "I no be his student."], a: "I am not his student.", note: "1-3：B 動詞否定句結構 [cite: 2, 45]。" },
    { q: "Choose the correct sentence:", opts: ["My father likes to play the violin.", "My father likes to playing violin.", "My father like to play the violin.", "My father is likes to play the violin."], a: "My father likes to play the violin.", note: "1-4：不定詞 to 之後接原形動詞 [cite: 2, 47]。" },
    { q: "Choose the correct sentence:", opts: ["He can swims.", "He can swim.", "He can to swim.", "He is can swim."], a: "He can swim.", note: "1-5：助動詞 can 後接原形動詞 [cite: 2, 51]。" },
    { q: "Choose the correct sentence:", opts: ["He hates eat fish.", "He hates to eat fish.", "He hate eat fish.", "He is hate to eat fish."], a: "He hates to eat fish.", note: "1-6：hate 後接不定詞 [cite: 2, 54]。" },
    { q: "Choose the correct sentence:", opts: ["My father go to church every Sunday.", "My father goes to church every Sunday.", "My father is go to church every Sunday.", "My father going to church every Sunday."], a: "My father goes to church every Sunday.", note: "1-7：規律習慣用現在簡單式，單數加 s [cite: 2, 57]。" },
    { q: "Choose the correct sentence:", opts: ["He does not love music.", "He do not live music.", "He is not love music.", "He not loves music."], a: "He does not love music.", note: "1-8：一般動詞否定需用助動詞 does [cite: 2, 59]。" },
    { q: "Choose the correct sentence:", opts: ["He walks to work every day.", "He walks to works every day.", "He walk to work every day.", "He is walk to work every day."], a: "He walks to work every day.", note: "1-9：單數主詞動詞變化及固定片語 walk to work [cite: 2, 62]。" },
    { q: "Choose the correct sentence:", opts: ["Can he to swim?", "Can he swim?", "Does he can swim?", "Can he swims?"], a: "Can he swim.", note: "1-10：助動詞問句結構 [cite: 2, 66]。" },
    { q: "Choose the correct sentence:", opts: ["I am walking to school every day.", "I walk to school every day.", "I walks to school every day.", "I am walk to school every day."], a: "I walk to school every day.", note: "1-11：習慣性動作不使用進行式 [cite: 3, 69]。" },
    { q: "Choose the correct sentence:", opts: ["I watch TV now.", "I am watching TV now.", "I watching TV now.", "I am watch TV now."], a: "I am watching TV now.", note: "1-12：now 提示現在進行式 [cite: 3, 72]。" },
    { q: "Choose the correct sentence:", opts: ["He calls his father every day.", "He is calling his father every day.", "He call his father every day.", "He calling his father every day."], a: "He calls his father every day.", note: "1-13：每日習慣用現在簡單式 [cite: 3, 74]。" },
    { q: "Choose the correct sentence:", opts: ["He is taking a walk in the morning every day.", "He takes a walk in the morning every day.", "He take a walk in the morning every day.", "He is take a walk every day."], a: "He takes a walk in the morning every day.", note: "1-14：規律晨間散步用簡單式 [cite: 3, 78]。" },
    { q: "Choose the correct sentence:", opts: ["He is playing the piano now.", "He plays the piano now.", "He playing the piano now.", "He is play the piano now."], a: "He is playing the piano now.", note: "1-15：正在彈鋼琴 [cite: 3, 80]。" },
    { q: "Choose the correct sentence:", opts: ["He is reading a book now.", "He reads a book now.", "He reading a book now.", "He is read a book now."], a: "He is reading a book now.", note: "1-16：正在閱讀 [cite: 3, 83]。" },
    { q: "Choose the correct sentence:", opts: ["He swims every morning.", "He is swimming every morning.", "He swim every morning.", "He swimming every morning."], a: "He swims every morning.", note: "1-17：習慣性晨泳 [cite: 3, 86]。" },
    { q: "Choose the correct sentence:", opts: ["He is writing a letter at present.", "He writing a letter at present.", "He writes a letter at present.", "He is write a letter at present."], a: "He is writing a letter at present.", note: "1-18：at present 用進行式 [cite: 3, 89]。" },
    { q: "Choose the correct sentence:", opts: ["He talks to his mother now.", "He is talking to his mother now.", "He talking to his mother now.", "He talk to his mother now."], a: "He is talking to his mother now.", note: "1-19：強調「現在」正在通話 [cite: 3, 93]。" },
    { q: "Choose the correct sentence:", opts: ["I am swim every day.", "I swim every day.", "I swimming every day.", "I am swimming every day."], a: "I swim every day.", note: "1-20：I 搭配原形動詞表示習慣 [cite: 3, 96]。" },
    { q: "Choose the correct sentence:", opts: ["I walked to school when I was a kid.", "I walk to school when I was a kid.", "I was walk to school when I was a kid.", "I had walk to school when I was a kid."], a: "I walked to school when I was a kid.", note: "1-21：過去發生的習慣，動詞用過去式 [cite: 4, 98]。" },
    { q: "Choose the correct sentence:", opts: ["I eat two eggs in the morning today.", "I ate two eggs in the morning today.", "I am eat two eggs in the morning today.", "I eaten two eggs in the morning today."], a: "I ate two eggs in the morning today.", note: "1-22：已完成的動作（吃過了）用過去式 [cite: 4, 102]。" },
    { q: "Choose the correct sentence:", opts: ["I do not like music when I was young.", "I did not like music when I was young.", "I am not like music when I was young.", "I not liked music when I was young."], a: "I did not like music when I was young.", note: "1-23：過去的否定用 did not [cite: 4, 105]。" },
    { q: "Choose the correct sentence:", opts: ["I do not go home yesterday.", "I did not go home yesterday.", "I am not go home yesterday.", "I was not go home yesterday."], a: "I did not go home yesterday.", note: "1-24：昨天沒回家，用 did not + 原形 [cite: 4, 108]。" },
    { q: "Choose the correct sentence:", opts: ["He is already very good in playing piano when he was six.", "He was already very good at playing piano when he was six.", "He is already very good at playing piano when he was six.", "He was already very good in playing piano when he was six."], a: "He was already very good at playing piano when he was six.", note: "1-25：be good at 為固定用法，且時態須一致 [cite: 4, 111]。" },
    { q: "Choose the correct sentence:", opts: ["They were my students five years ago.", "They are my students five years ago.", "They been my students five years ago.", "They was my students five years ago."], a: "They were my students five years ago.", note: "1-26：複數過去式 B 動詞用 were [cite: 4, 113]。" },
    { q: "Choose the correct sentence:", opts: ["Did you go to the church last Sunday?", "Do you go the church last Sunday?", "Are you go to the church last Sunday?", "Were you go to the church last Sunday?"], a: "Did you go to the church last Sunday?", note: "1-27：過去時間的問句用 Did [cite: 4, 116]。" },
    { q: "Choose the correct sentence:", opts: ["I am very sad when I heard the bad news yesterday.", "I was very sad when I heard the bad news yesterday.", "I very sad when I heard the bad news yesterday.", "I am been very sad when I heard the news yesterday."], a: "I was very sad when I heard the bad news yesterday.", note: "1-28：當時感到悲傷，時態需前後一致 [cite: 4, 119]。" },
    { q: "Choose the correct sentence:", opts: ["He does not know how to swim when he was a kid.", "He did not know how to swim when he was a kid.", "He not know how to swim when he was a kid.", "He is not know how to swim when he was a kid."], a: "He did not know how to swim when he was a kid.", note: "1-29：描述小時候不具備的能力用 past tense [cite: 4, 123]。" },
    { q: "Choose the correct sentence:", opts: ["The earth goes around the sun.", "The earth went around the sun.", "The earth is go around the sun.", "The earth going around the sun."], a: "The earth goes around the sun.", note: "1-30：真理、事實恆用現在簡單式 [cite: 4, 125]。" },
    { q: "Choose the correct sentence:", opts: ["When you came to my house, I am calling my father.", "When you came to my house, I was calling my father.", "When you come to my house, I was calling my father.", "When you came to my house, I called my father."], a: "When you came to my house, I was calling my father.", note: "1-31：過去某動作發生時，另一動作正在進行 [cite: 5, 129]。" },
    { q: "Choose the correct sentence:", opts: ["I could not answer you because I am taking a shower.", "I could not answer you because I was taking a shower.", "I cannot answer you because I was taking a shower.", "I could not answer you because I taken a shower."], a: "I could not answer you because I was taking a shower.", note: "1-32：描述當時正在洗澡，所以沒接電話 [cite: 5, 134]。" },
    { q: "Choose the correct sentence:", opts: ["When the train reached the station, people are dancing there.", "When the train reached the station, people were dancing there.", "When the train reach the station, people were dancing there.", "When the train reached the station, people danced there."], a: "When the train reached the station, people were dancing there.", note: "1-33：過去進行中的背景動作 [cite: 5, 137]。" },
    { q: "Choose the correct sentence:", opts: ["When you called me last night, I watched TV.", "When you called me last night, I was watching TV.", "When you call me last night, I am watching TV.", "When you called me last night, I watching TV."], a: "When you called me last night, I was watching TV.", note: "1-34：強調當時「正在看電視」 [cite: 5, 141]。" },
    { q: "Choose the correct sentence:", opts: ["My mother always cooked when I went home.", "My mother was always cooking when I went home.", "My mother always cook when I went home.", "My mother is always cooking when I went home."], a: "My mother was always cooking when I went home.", note: "1-35：過去習慣性正在發生的動作 [cite: 5, 143]。" },
];

let userData = JSON.parse(localStorage.getItem('kana_v8')) || { mastered: 0, currentLevel: 0, failed_list: [], stickers: [] };
let currentGroup = [];
let totalInGroup = 20;
let isLocked = false;
let isRetryMode = false;

function init() {
    document.getElementById('mastered-count').innerText = userData.mastered;
    document.getElementById('failed-count').innerText = userData.failed_list.length;
    document.getElementById('sticker-count').innerText = userData.stickers.length;
    const btn = document.getElementById('retry-btn');
    btn.style.display = (userData.failed_list && userData.failed_list.length > 0) ? "inline-block" : "none";
}

function startLevel() {
    isRetryMode = false;
    const startIdx = (userData.currentLevel % Math.ceil(allQuestions.length/20)) * 20;
    currentGroup = allQuestions.slice(startIdx, startIdx + 20).sort(() => Math.random() - 0.5);
    setupGame();
}

function startRetry() {
    isRetryMode = true;
    currentGroup = [...userData.failed_list].sort(() => Math.random() - 0.5);
    setupGame();
}

function setupGame() {
    totalInGroup = currentGroup.length;
    document.getElementById('total-num').innerText = totalInGroup;
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('game-zone').classList.remove('hidden');
    document.getElementById('back-home').classList.remove('hidden');
    renderQuestion();
}

function renderQuestion() {
    isLocked = false;
    if (currentGroup.length === 0) return finishLevel();
    
    const data = currentGroup[0];
    document.getElementById('q-text').innerText = data.q;
    document.getElementById('hint-text').innerText = data.note;
    document.getElementById('hint-area').classList.add('hidden');
    
    const area = document.getElementById('choices-area');
    area.innerHTML = "";
    data.opts.forEach(opt => {
        const b = document.createElement('button');
        b.className = "btn-choice";
        b.innerText = opt;
        b.onclick = () => handleSelect(opt, b);
        area.appendChild(b);
    });

    const solved = totalInGroup - currentGroup.length;
    document.getElementById('progress-num').innerText = solved;
    const p = (solved/totalInGroup)*100;
    document.getElementById('progress-bar').style.width = p + "%";
    document.getElementById('piske-img').style.left = p + "%";
}

function handleSelect(opt, b) {
    if (isLocked) return;
    isLocked = true;
    const cur = currentGroup[0];
    const choices = document.querySelectorAll('.btn-choice');
    
    document.getElementById('hint-area').classList.remove('hidden');

    if (opt === cur.a) {
        // 答對
        document.getElementById('feedback-img').src = IMG_YES + "?t=" + Date.now();
        document.getElementById('feedback-overlay').style.display = "block";
        b.style.background = "#b2cecf";
        if (isRetryMode) {
            userData.failed_list = userData.failed_list.filter(item => item.q !== cur.q);
        } else {
            userData.mastered++;
        }
        setTimeout(() => {
            document.getElementById('feedback-overlay').style.display = "none";
            currentGroup.shift();
            saveData();
            renderQuestion();
        }, 1200);
    } else {
        // 答錯
        document.getElementById('feedback-img').src = IMG_WRONG + "?t=" + Date.now();
        document.getElementById('feedback-overlay').style.display = "block";
        
        // 修正：點錯的變灰色，正確的亮紅色
        b.classList.add('btn-wrong-select');
        choices.forEach(btn => {
            if (btn.innerText === cur.a) {
                btn.classList.add('btn-correct-reveal');
            }
        });

        if (!isRetryMode && !userData.failed_list.some(item => item.q === cur.q)) {
            userData.failed_list.push(cur);
        }

        setTimeout(() => {
            document.getElementById('feedback-overlay').style.display = "none";
            currentGroup.push(currentGroup.shift());
            renderQuestion();
        }, 2000); // 延長一點時間讓使用者看正確答案
    }
}

function finishLevel() {
    document.getElementById('win-overlay').style.display = "flex";
    if (!isRetryMode) userData.currentLevel++;
    saveData();
}

function saveData() { 
    localStorage.setItem('kana_v8', JSON.stringify(userData)); 
}

init();
</script>
</body>
</html>
