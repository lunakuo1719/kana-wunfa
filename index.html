<!DOCTYPE html><html lang="zh-Hant"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="apple-touch-icon" href="https://lunakuo1719.github.io/kana-wunfa/nanaicon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æ–‡æ³•è¨ä¼åœ˜~æï¼</title>

    <style>
        :root {
            --kanahei-pink: #fce4ec; 
            --kanahei-rose: #f06292; 
            --kanahei-brown: #6d4c41; 
            --kanahei-cream: #fff9c4; 
            --gold: #fbc02d;
            --soft-white: #ffffff;
        }

        * { 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            font-weight: 800;
            -webkit-tap-highlight-color: transparent; 
        }

        body { 
            margin: 0; 
            padding: env(safe-area-inset-top) 15px env(safe-area-inset-bottom) 15px;
            /* é…è‰²å„ªåŒ–ï¼šæ”¹ç‚ºæŸ”å’Œæ¼¸å±¤ */
            background: linear-gradient(135deg, var(--kanahei-pink) 0%, #fff0f5 100%); 
            display: flex; 
            flex-direction: column; /* è®“å…§å®¹å‚ç›´æ’åˆ— */
            justify-content: center; 
            align-items: center; 
            height: 100vh;
            overflow: hidden;
        }

        .card {
            width: 100%;
            max-width: 450px;
            height: 85vh; /* ç¸®å°ä¸€é»å¡ç‰‡é«˜åº¦ï¼Œç•™ç©ºé–“çµ¦ä¸‹æ–¹çš„è¿”å›éµ */
            background: white;
            border: 4px solid var(--kanahei-brown);
            border-radius: 40px; 
            padding: 20px;
            box-shadow: 0px 8px 15px rgba(240, 98, 146, 0.3); /* ç¾åŒ–ï¼šå¢åŠ æŸ”å’Œé™°å½± */
            position: relative;
            display: flex;
            flex-direction: column;
            z-index: 2;
        }

        /* è¿”å›éµé‡è£½ï¼šç§»è‡³ä¸‹æ–¹ç©ºç™½è™• */
        .back-home-container {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 15px 0;
            z-index: 10;
        }
        .back-btn-large { 
            width: 70px; /* åŠ å¤§åœ–ç¤º */
            height: 70px; 
            cursor: pointer;
            filter: drop-shadow(0px 4px 4px rgba(0,0,0,0.2));
            transition: transform 0.2s;
        }
        .back-btn-large:active { transform: scale(0.9); }

        .header-gifs { 
            display: flex; justify-content: center; align-items: flex-end; 
            gap: 10px; margin: 10px 0 10px 0;
        }
        .header-gifs img { width: 25%; height: auto; max-width: 90px; }
        .header-gifs img:nth-child(2) { width: 32%; max-width: 120px; }

        .daily-tip-box {
            background: white; border: 2px solid var(--kanahei-rose);
            border-radius: 15px; padding: 15px; margin-bottom: 15px;
            font-size: 18px; color: var(--kanahei-brown); line-height: 1.5;
            box-shadow: inset 0 0 10px var(--kanahei-pink);
        }
        .daily-tip-box b { color: var(--kanahei-rose); }

        .progress-container { margin: 15px 0 35px 0; position: relative; height: 50px; }
        .piske-runner { 
            position: absolute; bottom: 15px; width: 65px; 
            transition: left 0.3s; margin-left: -32px; z-index: 10;
        }
        .bar-outer { 
            height: 18px; background: var(--kanahei-cream); 
            border: 3px solid var(--kanahei-brown); border-radius: 15px; 
            width: 100%; position: absolute; bottom: 0;
        }
        .bar-inner { height: 100%; width: 0%; background: var(--kanahei-rose); transition: width 0.3s; }

        .q-box { 
            font-size: 26px; color: var(--kanahei-brown); 
            margin-bottom: 25px; text-align: left; line-height: 1.5;
            min-height: 80px;
        }

        .btn-choice { 
            background: white; margin-bottom: 15px; font-size: 22px; 
            border: 3px solid var(--kanahei-brown); border-radius: 20px; 
            width: 100%; padding: 18px; text-align: left; 
            color: var(--kanahei-brown); box-shadow: 0 6px 0 #eee; /* å¢åŠ ä¸€é»é™°å½±æ·±åº¦ */
            transition: all 0.1s;
        }
        .btn-choice:active { transform: translateY(3px); box-shadow: 0 2px 0 #eee; }

        .translation-box { 
            background: var(--kanahei-cream); 
            padding: 15px; border-radius: 20px; 
            font-size: 18px; border: 3px solid var(--gold); 
            color: var(--kanahei-brown); text-align: left;
            margin-top: auto; margin-bottom: 5px;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.05);
            animation: popUp 0.3s ease-out;
            overflow-y: auto; max-height: 150px;
        }
        .translation-box::before {
            content: "ğŸ“œ è¨ä¼æ”»ç•¥ç­†è¨˜ï¼š";
            display: block; font-size: 14px; font-weight: 900;
            color: var(--kanahei-rose); margin-bottom: 5px;
            border-bottom: 1px dashed var(--gold);
        }

        @keyframes popUp {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .main-btn { 
            width: 100%; padding: 18px; font-size: 24px; border-radius: 35px; 
            background: var(--kanahei-rose); color: white; border: 4px solid var(--kanahei-brown); 
            box-shadow: 0 5px 0 var(--kanahei-brown); margin: 10px 0;
            transition: 0.1s;
        }
        .main-btn:active { transform: translateY(3px); box-shadow: 0 2px 0 var(--kanahei-brown); }

        .hidden { display: none !important; }

        #feedback-overlay {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 999; display: none; pointer-events: none;
        }
        #feedback-overlay img { width: 180px; }

        #win-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            display: none; flex-direction: column; justify-content: center;
            align-items: center; z-index: 1000; padding: 20px;
        }
        .reward-img { width: 85%; max-width: 300px; border: 5px solid var(--kanahei-brown); border-radius: 20px; }
    </style></head><body>

<div id="feedback-overlay"><img id="feedback-img" src=""></div>

<div id="win-overlay" onclick="location.reload()">
    <h2 id="win-msg" style="color: var(--kanahei-rose); font-size: 24px;">ç²å¾—æ–°è²¼ç´™ï¼æï¼</h2>
    <img id="reward-img" class="reward-img" src="">
    <h1 style="color: var(--kanahei-brown); font-size: 28px;">æ”»ç•¥æˆåŠŸï¼æï¼</h1>
    <p style="font-size: 18px;">é»æ“Šç•«é¢å›åˆ°é¦–é </p>
</div>

<div id="collection-overlay" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; display: none; flex-direction: column; z-index: 2000; padding: 20px; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="color: var(--kanahei-rose); font-size: 24px;">æˆ‘çš„æ”¶é›†å†Š</h2>
        <button onclick="document.getElementById('collection-overlay').style.display='none'" style="padding: 10px 20px; border-radius: 15px; border: 2px solid var(--kanahei-brown); font-size: 18px;">é—œé–‰</button>
    </div>
    <div id="album-container" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px;"></div>
</div>

<div class="card">
    <div id="dashboard">
        <div class="header-gifs">
            <img src="https://lunakuo1719.github.io/kana-wunfa/heade-M.gif">
            <img src="https://lunakuo1719.github.io/kana-wunfa/xmas.gif">
            <img src="https://lunakuo1719.github.io/kana-wunfa/heade_r.gif">
        </div>
        <h1 style="color: var(--kanahei-rose); margin:0 0 10px 0; font-size: 28px; text-align: center;">æ–‡æ³•è¨ä¼åœ˜~æï¼</h1>
        
        <div class="daily-tip-box">
            ğŸ’¡ <b>é•·è€çš„å»ºè­°ï¼š</b><span id="tip-text">æ­£åœ¨ç¿»é–±æ”»ç•¥æœ¬...</span>
        </div>

        <div style="background: var(--kanahei-cream); padding: 15px; border-radius: 25px; border: 3px solid var(--kanahei-brown); margin-bottom: 10px; text-align: center;">
            <p style="font-size:18px; margin:5px 0;">å·²ç†Ÿç·´ï¼š<span id="mastered-count" style="color:var(--kanahei-rose)">0</span></p>
            <p style="font-size:18px; margin:5px 0;">éŒ¯é¡Œæ•¸ï¼š<span id="failed-count">0</span> | è²¼ç´™ï¼š<span id="sticker-count">0</span>/80</p>
        </div>
        <button class="main-btn" onclick="startLevel()">é–‹å§‹è¨ä¼ï¼</button>
        <button id="retry-btn" class="main-btn" style="background:#b2cecf; display:none;" onclick="startRetry()">éŒ¯é¡Œè£œè€ƒ</button>
        <button class="main-btn" style="background:#ffd54f;" onclick="openAlbum()">æˆ‘çš„æ”¶é›†å†Š</button>
    </div>

    <div id="game-zone" class="hidden">
        <div style="display: flex; justify-content: space-between; font-size: 18px; color: var(--kanahei-brown); margin-top: 5px;">
            <span id="mode-text">è¨ä¼é€²è¡Œä¸­...</span>
            <span><span id="progress-num">0</span> / <span id="total-num">20</span></span>
        </div>
        <div class="progress-container">
            <img id="piske-img" src="https://lunakuo1719.github.io/kana-wunfa/cutepi.gif" class="piske-runner">
            <div class="bar-outer"><div class="bar-inner" id="progress-bar"></div></div>
        </div>
        <div id="q-text" class="q-box"></div>
        <div id="choices-area" style="flex-grow: 1;"></div>
        <div id="hint-area" class="translation-box hidden"><span id="hint-text"></span></div>
    </div>
</div>

<div id="back-home-wrapper" class="back-home-container hidden">
    <img id="back-home" src="https://lunakuo1719.github.io/kana-wunfa/back_01.png" class="back-btn-large" onclick="location.reload()">
</div>

<script>
// ==========================================
// é¡Œåº«å€ï¼šè«‹åœ¨æ­¤è²¼ä¸Šä½ æ‰€æœ‰çš„é¡Œåº«è³‡æ–™
// ==========================================
const allQuestions = [
    { q: "This is _______ elephant.", options: ["a", "an", "X", "the"], a: "an", note: "ä¸­æ–‡ç¿»è­¯ï¼šé€™æ˜¯ä¸€éš»å¤§è±¡ã€‚" },
    { q: "His sons _______ good boys.", options: ["is", "are", "do", "have"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–çš„å…’å­å€‘æ˜¯å¥½ç”·å­©ã€‚" },
];

// ==========================================
// ä¸»ç¨‹å¼é‚è¼¯ (ä¿æŒåŸæœ‰é‚è¼¯ï¼Œåƒ…å¾®èª¿ä»‹é¢æ§åˆ¶)
// ==========================================
const IMG_YES = "https://lunakuo1719.github.io/kana-wunfa/heartna.gif";
const IMG_WRONG = "https://lunakuo1719.github.io/kana-wunfa/Wrong.gif";
const STICKERS_NORMAL = Array.from({length: 70}, (_, i) => `https://lunakuo1719.github.io/kana-wunfa/stickers/${String(i+1).padStart(2, '0')}.jpg`);
const STICKERS_SPECIAL = Array.from({length: 10}, (_, i) => `https://lunakuo1719.github.io/kana-wunfa/stickers/special/${String(i+1).padStart(2, '0')}.jpg`);

const grammarTips = [
    "éå»é€²è¡Œå¼ (was/were + V-ing) å¸¸å‡ºç¾åœ¨ When ä¹‹å¾Œï¼Œæè¿°ç•¶æ™‚ã€Œæ­£åœ¨é€²è¡Œã€çš„äº‹å–”ï¼",
    "çœ‹åˆ° Since (è‡ªå¾...)ï¼Œé€šå¸¸å°±è¦å¬å–šã€Œç¾åœ¨å®Œæˆå¼ (have/has + p.p.)ã€ä¾†å¹«å¿™ï¼æï¼",
    "ä¸€èˆ¬å‹•è©çš„å¦å®šå¥è¦è«‹åŠ©å‹•è© (Do/Does/Did) å‡ºé¦¬ï¼Œä¸èƒ½è‡ªå·±åŠ  not å–”ï¼",
    "è¢«å‹•èªæ…‹ (è¢«...) ä¸€å®šè¦æœ‰ be å‹•è© + éå»åˆ†è© (p.p.)ï¼Œç¼ºä¸€ä¸å¯ï¼",
    "å‹•è©è¦ç•¶ä¸»è©æ™‚ï¼Œè¨˜å¾—ç©¿ä¸Š V-ing æˆ– To-V çš„å¤–è¡£ï¼Œæ‰ä¸æœƒæ„Ÿå†’å–”ï¼",
    "å½¢å®¹ã€Œäº‹ç‰©ã€è®“äººæ„Ÿè¦ºå¦‚ä½•ç”¨ -ing (interesting)ï¼Œå½¢å®¹ã€Œäººã€çš„æ„Ÿè¦ºç”¨ -ed (interested)ï¼"
];

let userData = JSON.parse(localStorage.getItem('kana_v9')) || { mastered: 0, currentLevel: 0, failed_list: [], stickers: [] };
let currentGroup = [];
let totalInGroup = 20;
let isLocked = false;
let isRetryMode = false;

function init() {
    document.getElementById('mastered-count').innerText = userData.mastered;
    document.getElementById('failed-count').innerText = (userData.failed_list && userData.failed_list.length) || 0;
    document.getElementById('sticker-count').innerText = userData.stickers.length;
    const btn = document.getElementById('retry-btn');
    btn.style.display = (userData.failed_list && userData.failed_list.length > 0) ? "inline-block" : "none";
    document.getElementById('tip-text').innerText = grammarTips[Math.floor(Math.random() * grammarTips.length)];
}

function startLevel() {
    isRetryMode = false;
    document.getElementById('mode-text').innerText = "æ­£å¼è¨ä¼ä¸­...";
    const startIdx = (userData.currentLevel % Math.ceil(allQuestions.length/20)) * 20;
    currentGroup = allQuestions.slice(startIdx, startIdx + 20).sort(() => Math.random() - 0.5);
    setupGame();
}

function startRetry() {
    isRetryMode = true;
    document.getElementById('mode-text').innerText = "éŒ¯é¡Œè£œè€ƒä¸­...";
    currentGroup = [...userData.failed_list].sort(() => Math.random() - 0.5);
    setupGame();
}

function setupGame() {
    if (currentGroup.length === 0) return alert("ç›®å‰æ²’æœ‰é¡Œç›®å¯ä»¥è¨ä¼å–”ï¼");
    totalInGroup = currentGroup.length;
    document.getElementById('total-num').innerText = totalInGroup;
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('game-zone').classList.remove('hidden');
    // é¡¯ç¤ºä¸‹æ–¹çš„è¿”å›éµå®¹å™¨
    document.getElementById('back-home-wrapper').classList.remove('hidden');
    renderQuestion();
}

function renderQuestion() {
    isLocked = false;
    if (currentGroup.length === 0) return finishLevel();
    const data = currentGroup[0];
    document.getElementById('q-text').innerText = data.q;
    document.getElementById('hint-text').innerText = data.note || "åŠ æ²¹ï¼é€™é¡Œä¸€å®šæ²’å•é¡Œçš„ï¼";
    document.getElementById('hint-area').classList.add('hidden');
    
    const area = document.getElementById('choices-area');
    area.innerHTML = "";
    
    const choices = data.options || data.opts || [];
    choices.forEach(opt => {
        const b = document.createElement('button');
        b.className = "btn-choice"; b.innerText = opt;
        b.onclick = () => handleSelect(opt, b);
        area.appendChild(b);
    });
    
    const solved = totalInGroup - currentGroup.length;
    document.getElementById('progress-num').innerText = solved;
    const p = (solved/totalInGroup)*100;
    document.getElementById('progress-bar').style.width = p + "%";
    document.getElementById('piske-img').style.left = p + "%";
}

function handleSelect(opt, b) {
    if (isLocked) return;
    isLocked = true;
    const cur = currentGroup[0];
    const choices = document.querySelectorAll('.btn-choice');
    document.getElementById('hint-area').classList.remove('hidden');

    if (opt === cur.a) {
        document.getElementById('feedback-img').src = IMG_YES + "?t=" + Date.now();
        document.getElementById('feedback-overlay').style.display = "block";
        b.style.backgroundColor = "#b2cecf"; 
        
        if (isRetryMode) {
            userData.failed_list = userData.failed_list.filter(item => item.q !== cur.q);
        } else {
            userData.mastered++;
        }
        
        setTimeout(() => {
            document.getElementById('feedback-overlay').style.display = "none";
            currentGroup.shift();
            saveData();
            renderQuestion();
        }, 1500);
    } else {
        document.getElementById('feedback-img').src = IMG_WRONG + "?t=" + Date.now();
        document.getElementById('feedback-overlay').style.display = "block";
        b.style.backgroundColor = "#eee";
        b.style.color = "#aaa";
        
        choices.forEach(btn => { 
            if (btn.innerText === cur.a) { 
                btn.style.backgroundColor = "var(--kanahei-rose)"; 
                btn.style.color="white"; 
            } 
        });

        if (!isRetryMode && !userData.failed_list.some(item => item.q === cur.q)) {
            userData.failed_list.push(cur);
        }

        setTimeout(() => {
            document.getElementById('feedback-overlay').style.display = "none";
            currentGroup.push(currentGroup.shift());
            renderQuestion();
        }, 2500);
    }
}

function finishLevel() {
    const isSpecial = Math.random() < 0.15;
    const pool = isSpecial ? STICKERS_SPECIAL : STICKERS_NORMAL;
    const winUrl = pool[Math.floor(Math.random() * pool.length)];
    if (!userData.stickers.includes(winUrl)) userData.stickers.push(winUrl);
    
    document.getElementById('reward-img').src = winUrl;
    document.getElementById('win-msg').innerText = isSpecial ? "âœ¨ é©šå–œç¨€æœ‰è²¼ç´™å…¥æ‰‹ï¼æï¼ âœ¨" : "ç²å¾—æ–°è²¼ç´™ï¼æï¼";
    document.getElementById('win-overlay').style.display = "flex";
    
    if (!isRetryMode) userData.currentLevel++;
    saveData();
}

function openAlbum() {
    const container = document.getElementById('album-container');
    container.innerHTML = "";
    [...STICKERS_NORMAL, ...STICKERS_SPECIAL].forEach((url) => {
        const item = document.createElement('div');
        item.style.cssText = "aspect-ratio:1; border:2px dashed #ccc; border-radius:10px; overflow:hidden; background:#fafafa; display:flex; align-items:center; justify-content:center;";
        item.innerHTML = userData.stickers.includes(url) ? `<img src="${url}" style="width:100%;height:100%;object-fit:cover;">` : `<span style="color:#ccc;font-size:12px;">?</span>`;
        container.appendChild(item);
    });
    document.getElementById('collection-overlay').style.display = "flex";
}

function saveData() { localStorage.setItem('kana_v9', JSON.stringify(userData)); }
init();
</script></body></html>
