<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    
    <link rel="apple-touch-icon" href="https://lunakuo1719.github.io/kana-wunfa/nanaicon.jpg">
    <meta name="apple-mobile-web-app-title" content="æ–‡æ³•è¨ä¼åœ˜">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <title>æ–‡æ³•è¨ä¼åœ˜~æï¼</title>
    <style>
        :root {
            --kanahei-pink: #fce4ec; 
            --kanahei-rose: #f06292; 
            --kanahei-brown: #6d4c41; 
            --kanahei-cream: #fff9c4; 
            --kanahei-correct: #ff80ab; 
            --morandi-mint: #b2cecf;   
            --morandi-text: #5a7677;   
        }

        * { box-sizing: border-box; font-family: 'Arial', sans-serif; font-weight: 900; }

        body { margin: 0; padding: 10px; background-color: var(--kanahei-pink); display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }

        .card {
            width: 100%; max-width: 500px; background: white;
            border: 6px solid var(--kanahei-brown);
            border-radius: 45px; padding: 25px;
            box-shadow: 0px 12px 0px var(--kanahei-rose);
            position: relative; text-align: center;
            z-index: 10; max-height: 90vh; overflow-y: auto;
        }

        .main-header-gif { width: 100px; margin-bottom: 5px; }

        .home-btn { position: absolute; top: 15px; right: 15px; width: 50px; cursor: pointer; z-index: 100; }
        .home-btn img { width: 100%; height: auto; }

        .progress-container { position: relative; height: 80px; margin-top: 10px; }
        .piske-runner { 
            position: absolute; bottom: 25px; left: 0%; 
            width: 50px; height: 50px; transition: left 0.4s ease;
            margin-left: -25px; z-index: 2;
        }
        .bar-outer { position: absolute; bottom: 10px; width: 100%; height: 16px; background: var(--kanahei-cream); border: 3px solid var(--kanahei-brown); border-radius: 10px; overflow: hidden; }
        .bar-inner { height: 100%; width: 0%; background: var(--kanahei-rose); transition: width 0.4s; }

        .btn-choice { background: white; margin-bottom: 12px; font-size: 18px; border: 3px solid var(--kanahei-brown); border-radius: 20px; width: 100%; padding: 14px; text-align: left; display: block; cursor: pointer; color: var(--kanahei-brown); }
        .choice-correct-mint { background-color: var(--morandi-mint) !important; color: var(--morandi-text) !important; border-color: var(--morandi-text) !important; }
        .choice-reveal-pink { background-color: var(--kanahei-correct) !important; color: white !important; }

        /* è²¼ç´™ç°¿æ¨£å¼ */
        .sticker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .sticker-item { width: 100%; aspect-ratio: 1/1; background: #eee; border-radius: 15px; border: 2px dashed #ccc; overflow: hidden; position: relative; }
        .sticker-item img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(100%); opacity: 0.3; }
        .sticker-item.unlocked { border: 2px solid var(--kanahei-rose); background: white; }
        .sticker-item.unlocked img { filter: none; opacity: 1; }

        .hidden { display: none; }
        .main-btn { padding: 12px 25px; font-size: 18px; border-radius: 30px; background: var(--kanahei-rose); color: white; border: 4px solid var(--kanahei-brown); cursor: pointer; box-shadow: 0 4px 0 var(--kanahei-brown); margin: 5px; }
        .translation-box { background: #fff8e1; padding: 12px; border-radius: 15px; margin-top: 10px; font-size: 16px; border: 2px dashed var(--kanahei-rose); }
    </style>
</head>
<body>

<div class="card">
    <div id="home-icon" class="home-btn hidden" onclick="goHome()">
        <img src="https://lunakuo1719.github.io/kana-wunfa/back_01.png" alt="Back">
    </div>

    <div id="dashboard">
        <img src="https://lunakuo1719.github.io/kana-wunfa/nana01.gif" class="main-header-gif">
        <h2 style="color: var(--kanahei-rose); margin:0;">æ–‡æ³•è¨ä¼åœ˜~æï¼</h2>
        <div style="background: var(--kanahei-cream); padding: 10px; border-radius: 15px; border: 3px solid var(--kanahei-brown); margin: 15px 0;">
            <p>å·²ç†Ÿç·´ï¼š<span id="mastered-count">0</span> | é—œå¡ï¼š<span id="lv-display">1</span></p>
            <p>éŒ¯é¡Œï¼š<span id="failed-count">0</span> | è²¼ç´™ï¼š<span id="sticker-count">0</span>/17</p>
        </div>
        <button class="main-btn" onclick="startLevel()">é–‹å§‹è¨ä¼ï¼</button><br>
        <button id="retry-btn" class="main-btn hidden" style="background:#b2cecf;" onclick="startRetry()">éŒ¯é¡Œè£œè€ƒ</button><br>
        <button class="main-btn" style="background:#ffd54f;" onclick="showBook()">æ”¶é›†å†Š</button>
    </div>

    <div id="game-zone" class="hidden">
        <div class="progress-container">
            <img id="piske-img" src="https://lunakuo1719.github.io/kana-wunfa/timeline.gif" class="piske-runner">
            <div class="bar-outer"><div class="bar-inner" id="progress-bar"></div></div>
            <span style="font-size:12px;">é€²åº¦ï¼š<span id="progress-num">0</span> / <span id="total-num">20</span></span>
        </div>
        <div id="q-text" style="text-align:left; font-size:20px; margin:15px 0;"></div>
        <div id="choices-area"></div>
        <div id="hint-area" class="translation-box hidden"><span id="hint-text"></span></div>
    </div>

    <div id="book-zone" class="hidden">
        <h3 style="color: var(--kanahei-rose);">æˆ‘çš„è²¼ç´™æ”¶é›†å†Š</h3>
        <div class="sticker-grid" id="sticker-grid"></div>
        <button class="main-btn" onclick="goHome()">å›é¦–é </button>
    </div>

    <div id="finish-zone" class="hidden">
        <div style="font-size: 50px;">ğŸŠ</div>
        <h2 id="finish-msg">æ”»ç•¥æˆåŠŸï¼</h2>
        <div id="new-sticker-alert" class="hidden">
            <p style="color:red;">è§£é–äº†æ–°è²¼ç´™ï¼</p>
            <img id="unlocked-img" src="" style="width:100px; border:3px solid var(--kanahei-brown); border-radius:10px;">
        </div>
        <button class="main-btn" onclick="goHome()">ç¹¼çºŒåŠªåŠ›ï¼</button>
    </div>
</div>

<script>
const STICKERS = Array.from({length: 17}, (_, i) => `https://lunakuo1719.github.io/kana-wunfa/stickers/badge_${String(i+1).padStart(2, '0')}.jpg`);

const allQuestions = [
    { q: "This is _______ elephant.", opts: ["a", "an", "X", "the"], a: "an", note: "ä¸­æ–‡ç¿»è­¯ï¼šé€™æ˜¯ä¸€éš»å¤§è±¡ã€‚" },
    { q: "I _______ a teacher.", opts: ["am", "is", "were", "be"], a: "am", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘æ˜¯ä¸€ä½è€å¸«ã€‚" },
    { q: "His sons _______ good boys.", opts: ["is", "are", "do", "have"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–çš„å…’å­å€‘æ˜¯å¥½ç”·å­©ã€‚" },
    { q: "They _______ cats.", opts: ["is am", "are", "be", "X"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šç‰ å€‘æ˜¯è²“ã€‚" },
    { q: "The moon _______ yellow.", opts: ["was", "were", "is", "am"], a: "is", note: "ä¸­æ–‡ç¿»è­¯ï¼šæœˆäº®æ˜¯é»ƒè‰²çš„ã€‚" },
    { q: "They _______ students.", opts: ["is", "are", "be", "am"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–å€‘æ˜¯å­¸ç”Ÿã€‚" },
    { q: "She _______ a doctor.", opts: ["do", "does", "are", "is"], a: "is", note: "ä¸­æ–‡ç¿»è­¯ï¼šå¥¹æ˜¯ä¸€ä½é†«ç”Ÿã€‚" },
    { q: "He _______ many books.", opts: ["is", "be", "have", "has"], a: "has", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–æœ‰å¾ˆå¤šæ›¸ã€‚" },
    { q: "We _______ many pens.", opts: ["is", "be", "have", "has"], a: "have", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘å€‘æœ‰å¾ˆå¤šç­†ã€‚" },
    { q: "A teacher works in a _______.", opts: ["school", "ship", "car", "train"], a: "school", note: "ä¸­æ–‡ç¿»è­¯ï¼šè€å¸«åœ¨å­¸æ ¡è£¡å·¥ä½œã€‚" },
    { q: "They have _______ dogs.", opts: ["twelve", "a", "one", "an"], a: "twelve", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–å€‘æœ‰12éš»ç‹—ã€‚" },
    { q: "We like _______ daughters.", opts: ["our", "yours", "us", "you"], a: "our", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘å€‘å–œæ­¡æˆ‘å€‘çš„å¥³å…’å€‘ã€‚" },
    { q: "_______ house is beautiful.", opts: ["I", "My", "Me", "Mine"], a: "My", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘çš„æˆ¿å­æ˜¯æ¼‚äº®çš„ã€‚" },
    { q: "Banana is _______.", opts: ["red", "brown", "yellow", "blue"], a: "yellow", note: "ä¸­æ–‡ç¿»è­¯ï¼šé¦™è•‰æ˜¯é»ƒè‰²çš„ã€‚" },
    { q: "Trees are _______.", opts: ["pink", "red", "black", "green"], a: "green", note: "ä¸­æ–‡ç¿»è­¯ï¼šæ¨¹æ˜¯ç¶ è‰²çš„ã€‚" },
    { q: "I am _______ teacher.", opts: ["he", "me", "they", "his"], a: "his", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘æ˜¯ä»–çš„è€å¸«ã€‚" },
    { q: "He is _______ teacher.", opts: ["mine", "my", "yours", "hers"], a: "my", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–æ˜¯æˆ‘çš„è€å¸«ã€‚" },
    { q: "We are talking _______ the book.", opts: ["in", "about", "on", "under"], a: "about", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘å€‘æ­£åœ¨èªªé‚£æœ¬æ›¸ã€‚" },
    { q: "They _______ happy.", opts: ["am", "is", "are", "be"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–å€‘å¾ˆå¿«æ¨‚ã€‚" },
    { q: "I _______ sad.", opts: ["am", "is", "are", "be"], a: "am", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘å¾ˆæ†‚å‚·ã€‚" },
    { q: "He _______ sad.", opts: ["am", "is", "are", "be"], a: "is", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–å¾ˆæ†‚å‚·ã€‚" },
    { q: "They _______ sad.", opts: ["am", "is", "are", "be"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–å€‘å¾ˆæ†‚å‚·ã€‚" },
    { q: "I _______ thin.", opts: ["am", "is", "are", "be"], a: "am", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘å¾ˆç˜¦ã€‚" },
    { q: "He _______ thin.", opts: ["am", "is", "are", "be"], a: "is", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–å¾ˆç˜¦ã€‚" },
    { q: "They _______ thin.", opts: ["am", "is", "are", "be"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–å€‘å¾ˆç˜¦ã€‚" },
    { q: "I _______ fat.", opts: ["am", "is", "are", "be"], a: "am", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘å¾ˆèƒ–ã€‚" },
    { q: "He _______ fat.", opts: ["am", "is", "are", "be"], a: "is", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–å¾ˆèƒ–ã€‚" },
    { q: "They _______ fat.", opts: ["am", "is", "are", "be"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–å€‘å¾ˆèƒ–ã€‚" },
    { q: "I _______ a student.", opts: ["am", "is", "are", "be"], a: "am", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘æ˜¯ä¸€å€‹å­¸ç”Ÿã€‚" },
    { q: "He _______ a student.", opts: ["am", "is", "are", "be"], a: "is", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–æ˜¯ä¸€å€‹å­¸ç”Ÿã€‚" },
    { q: "They _______ students.", opts: ["am", "is", "are", "be"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–å€‘æ˜¯å­¸ç”Ÿã€‚" },
    { q: "You _______ students.", opts: ["am", "is", "are", "be"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šä½ å€‘æ˜¯å­¸ç”Ÿã€‚" },
    { q: "I _______ a teacher.", opts: ["am", "is", "are", "be"], a: "am", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘æ˜¯ä¸€ä½è€å¸«ã€‚" },
    { q: "She _______ a teacher.", opts: ["am", "is", "are", "be"], a: "is", note: "ä¸­æ–‡ç¿»è­¯ï¼šå¥¹æ˜¯ä¸€ä½è€å¸«ã€‚" },
    { q: "They _______ teachers.", opts: ["am", "is", "are", "be"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–å€‘æ˜¯è€å¸«ã€‚" },
    { q: "We _______ teachers.", opts: ["am", "is", "are", "be"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘å€‘æ˜¯è€å¸«ã€‚" },
    { q: "The teacher _______ a good man.", opts: ["am", "is", "are", "be"], a: "is", note: "ä¸­æ–‡ç¿»è­¯ï¼šé€™ä½è€å¸«æ˜¯ä¸€å€‹å¥½äººã€‚" },
    { q: "The teachers _______ good men.", opts: ["am", "is", "are", "be"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šé€™äº›è€å¸«æ˜¯å¥½äººã€‚" },
    { q: "My father _______ a doctor.", opts: ["am", "is", "are", "be"], a: "is", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘çˆ¶è¦ªæ˜¯ä¸€ä½é†«ç”Ÿã€‚" },
    { q: "My mother _______ a nurse.", opts: ["am", "is", "are", "be"], a: "is", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘æ¯è¦ªæ˜¯ä¸€ä½è­·å£«ã€‚" },
    { q: "His parents _______ doctors.", opts: ["am", "is", "are", "be"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–çš„çˆ¶æ¯è¦ªæ˜¯é†«ç”Ÿã€‚" },
    { q: "This _______ a desk.", opts: ["am", "is", "are", "be"], a: "is", note: "ä¸­æ–‡ç¿»è­¯ï¼šé€™æ˜¯ä¸€å¼µæ›¸æ¡Œã€‚" },
    { q: "These _______ desks.", opts: ["am", "is", "are", "be"], a: "are", note: "ä¸­æ–‡ç¿»è­¯ï¼šé€™äº›æ˜¯æ›¸æ¡Œã€‚" },
    { q: "That _______ a chair.", opts: ["am", "is", "are", "be"], a: "is", note: "ä¸­æ–‡ç¿»è­¯ï¼šé‚£æ˜¯ä¸€å¼µæ¤…å­ã€‚" },
    { q: "Those _______ chairs.", opts: ["am", "is", "are", "be"], a: "are", note: "é‚£äº›æ˜¯æ¤…å­ã€‚" },
    { q: "The pen _______ blue.", opts: ["am", "is", "are", "be"], a: "is", note: "é€™æç­†æ˜¯è—è‰²çš„ã€‚" },
    { q: "The pens _______ blue.", opts: ["am", "is", "are", "be"], a: "are", note: "é€™äº›ç­†æ˜¯è—è‰²çš„ã€‚" },
    { q: "I _______ in the room.", opts: ["am", "is", "are", "be"], a: "am", note: "æˆ‘åœ¨æˆ¿é–“è£¡ã€‚" },
    { q: "He _______ in the room.", opts: ["am", "is", "are", "be"], a: "is", note: "ä»–åœ¨æˆ¿é–“è£¡ã€‚" },
    { q: "They _______ in the room.", opts: ["am", "is", "are", "be"], a: "are", note: "ä»–å€‘åœ¨æˆ¿é–“è£¡ã€‚" },
    { q: "My father _______ in the room.", opts: ["am", "is", "are", "be"], a: "is", note: "æˆ‘çˆ¶è¦ªåœ¨æˆ¿é–“è£¡ã€‚" },
    { q: "The book _______ on the table.", opts: ["am", "is", "are", "be"], a: "is", note: "é€™æœ¬æ›¸åœ¨æ¡Œå­ä¸Šã€‚" },
    { q: "He swims every morning.", opts: ["He swims every morning.", "He is swimming every morning.", "He swim every morning.", "He swimming every morning."], a: "He swims every morning.", note: "ç¿’æ…£ç”¨ç¾åœ¨ç°¡å–®å¼ã€‚" },
    { q: "He is writing a letter at present.", opts: ["He is writing a letter at present.", "He writing a letter at present.", "He writes a letter at present.", "He is write a letter at present."], a: "He is writing a letter at present.", note: "at present ä½¿ç”¨ç¾åœ¨é€²è¡Œå¼ã€‚" },
    { q: "He talks to his mother now.", opts: ["He talks to his mother now.", "He is talking to his mother now.", "He talking to his mother now.", "He talk to his mother now."], a: "He is talking to his mother now.", note: "now ä½¿ç”¨ç¾åœ¨é€²è¡Œå¼ã€‚" },
    { q: "I swim every day.", opts: ["I am swim every day.", "I swim every day.", "I swimming every day.", "I am swimming every day."], a: "I swim every day.", note: "I æ­é…åŸå½¢å‹•è©ã€‚" },
    { q: "I walked to school when I was a kid.", opts: ["I walked to school when I was a kid.", "I walk to school when I was a kid.", "I was walk to school when I was a kid.", "I had walk to school when I was a kid."], a: "I walked to school when I was a kid.", note: "éå»æ™‚é–“ç”¨éå»å¼ã€‚" },
    { q: "I ate two eggs in the morning today.", opts: ["I eat two eggs in the morning today.", "I ate two eggs in the morning today.", "I am eat two eggs in the morning today.", "I eaten two eggs in the morning today."], a: "I ate two eggs in the morning today.", note: "ä»Šå¤©å·²ç™¼ç”Ÿçš„å‹•ä½œã€‚" },
    { q: "I did not like music when I was young.", opts: ["I do not like music when I was young.", "I did not like music when I was young.", "I am not like music when I was young.", "I not liked music when I was young."], a: "I did not like music when I was young.", note: "éå»å¦å®šç”¨ did notã€‚" },
    { q: "I did not go home yesterday.", opts: ["I do not go home yesterday.", "I did not go home yesterday.", "I am not go home yesterday.", "I was not go home yesterday."], a: "I did not go home yesterday.", note: "æ˜¨å¤©æ²’å›å®¶ã€‚" },
    { q: "He was already very good at playing piano when he was six.", opts: ["He is already very good in playing piano when he was six.", "He was already very good at playing piano when he was six.", "He is already very good at playing piano when he was six.", "He was already very good in playing piano when he was six."], a: "He was already very good at playing piano when he was six.", note: "be good atã€‚" },
    { q: "They were my students five years ago.", opts: ["They were my students five years ago.", "They are my students five years ago.", "They been my students five years ago.", "They was my students five years ago."], a: "They were my students five years ago.", note: "è¤‡æ•¸éå»ç”¨ wereã€‚" },
    { q: "Did you go to the church last Sunday?", opts: ["Did you go to the church last Sunday?", "Do you go the church last Sunday?", "Are you go to the church last Sunday?", "Were you go to the church last Sunday?"], a: "Did you go to the church last Sunday?", note: "éå»å•å¥ç”¨ Didã€‚" },
    { q: "I was very sad when I heard the bad news yesterday.", opts: ["I am very sad when I heard the bad news yesterday.", "I was very sad when I heard the bad news yesterday.", "I very sad when I heard the bad news yesterday.", "I am been very sad when I heard the news yesterday."], a: "I was very sad when I heard the bad news yesterday.", note: "éå»ç‹€æ…‹ç”¨ wasã€‚" },
    { q: "He did not know how to swim when he was a kid.", opts: ["He does not know how to swim when he was a kid.", "He did not know how to swim when he was a kid.", "He not know how to swim when he was a kid.", "He is not know how to swim when he was a kid."], a: "He did not know how to swim when he was a kid.", note: "éå»çš„èƒ½åŠ›ã€‚" },
    { q: "The earth goes around the sun.", opts: ["The earth goes around the sun.", "The earth went around the sun.", "The earth is go around the sun.", "The earth going around the sun."], a: "The earth goes around the sun.", note: "ä¸è®ŠçœŸç†ã€‚" },
    { q: "When you came to my house, I was calling my father.", opts: ["When you came to my house, I am calling my father.", "When you came to my house, I was calling my father.", "When you come to my house, I was calling my father.", "When you came to my house, I called my father."], a: "When you came to my house, I was calling my father.", note: "éå»é€²è¡Œå¼ã€‚" },
    { q: "I could not answer you because I was taking a shower.", opts: ["I could not answer you because I am taking a shower.", "I could not answer you because I was taking a shower.", "I cannot answer you because I was taking a shower.", "I could not answer you because I taken a shower."], a: "I could not answer you because I was taking a shower.", note: "ç•¶æ™‚æ­£åœ¨æ´—æ¾¡ã€‚" },
    { q: "When the train reached the station, people were dancing there.", opts: ["When the train reached the station, people are dancing there.", "When the train reached the station, people were dancing there.", "When the train reach the station, people were dancing there.", "When the train reached the station, people danced there."], a: "When the train reached the station, people were dancing there.", note: "èƒŒæ™¯é€²è¡Œå‹•ä½œã€‚" },
    { q: "When you called me last night, I was watching TV.", opts: ["When you called me last night, I watched TV.", "When you called me last night, I was watching TV.", "When you call me last night, I am watching TV.", "When you called me last night, I watching TV."], a: "When you called me last night, I was watching TV.", note: "å¼·èª¿ç•¶ä¸‹å‹•ä½œã€‚" },
    { q: "My mother was always cooking when I went home.", opts: ["My mother always cooked when I went home.", "My mother was always cooking when I went home.", "My mother always cook when I went home.", "My mother is always cooking when I went home."], a: "My mother was always cooking when I went home.", note: "éå»çš„èƒŒæ™¯ã€‚" },
    { q: "It rained when I was walking back home.", opts: ["It rained when I walkes back home.", "It rained when I was walking back home.", "It is raining when I walked back home.", "It rain when I was walking back home."], a: "It rained when I was walking back home.", note: "èµ°è·¯æ™‚ä¸‹é›¨äº†ã€‚" },
    { q: "We were watching a movie when our mother called us.", opts: ["We are watching a movie when our mother called us.", "We were watching a movie when our mother called us.", "We watched a movie when our mother called us.", "We were watch a movie when our mother called us."], a: "We were watching a movie when our mother called us.", note: "æ­£åœ¨çœ‹é›»å½±ã€‚" },
    { q: "He was watching TV around eight oâ€™clock yesterday.", opts: ["He watched TV around eight oâ€™clock yesterday.", "He was watching TV around eight oâ€™clock yesterday.", "He is watching TV around eight oâ€™clock yesterday.", "He watching TV around eight oâ€™clock yesterday."], a: "He was watching TV around eight oâ€™clock yesterday.", note: "ç‰¹å®šéå»æ™‚åˆ»ã€‚" },
    { q: "I was studying mathematics when you came to my home.", opts: ["I was studying mathematics when you came to my home.", "I am studying mathematics when you came to my home.", "I studied mathematics when you came to my home.", "I was study mathematics when you came to my home."], a: "I was studying mathematics when you came to my home.", note: "éå»é€²è¡Œä¸­ã€‚" },
    { q: "She was preparing for dinner when her husband went home.", opts: ["She was preparing for dinner when her husband went home.", "She is preparing for dinner when her husband went home.", "She prepared for dinner when her husband went home.", "She was prepare for dinner when her husband went home."], a: "She was preparing for dinner when her husband went home.", note: "æº–å‚™æ™šé¤ã€‚" },
    { q: "Since 1939, I have lived here.", opts: ["Since 1939, I have live here.", "Since 1939, I have lived here.", "Since 1939, I am living here.", "Since 1939, I lived here."], a: "Since 1939, I have lived here.", note: "å®Œæˆå¼æ­é… sinceã€‚" },
    { q: "Since he was a child, he has lived here.", opts: ["Since he was a child, he has lived here.", "Since he was a child, he have lived here.", "Since he was a child, he is living here.", "Since he was a child, he lives here."], a: "Since he was a child, he has lived here.", note: "ä¸‰å–® has + p.p.ã€‚" },
    { q: "Since I was little, I have lived here.", opts: ["Since I was little, I have lived here.", "Since I was little, I am living here.", "Since I was little, I was living here.", "Since I was little, I lived here."], a: "Since I was little, I have lived here.", note: "æŒçºŒç‹€æ…‹ã€‚" },
    { q: "Since last year, I have not seen him.", opts: ["Since last year, I did not see him.", "Since last year, I have not seen him.", "Since last year, I am not seeing him.", "Since last year, I don't see him."], a: "Since last year, I have not seen him.", note: "å¦å®šå®Œæˆå¼ã€‚" },
    { q: "Since 1950, he has worked.", opts: ["Since 1950, he workd.", "Since 1950, he has worked.", "Since 1950, he is working.", "Since 1950, he was working."], a: "Since 1950, he has worked.", note: "å‹•ä½œæŒçºŒã€‚" },
    { q: "He has played tennis since he was in high school.", opts: ["He has played tennis since he was in high school.", "He played tennis since he was in high school.", "He has play tennis since he was in high school.", "He is playing tennis since he was in high school."], a: "He has played tennis since he was in high school.", note: "è‡ªé«˜ä¸­èµ·æŒçºŒã€‚" },
    { q: "He has practiced speaking English since he got into college.", opts: ["He has practiced speaking English since he got into college.", "He practiced speaking English since he got into college.", "He is practicing speaking English since he got into college.", "He has practice speaking English since he got into college."], a: "He has practiced speaking English since he got into college.", note: "since + éå»å¼å­å¥ã€‚" },
    { q: "He has taught in this school since 1950.", opts: ["He teaches in this school since 1950.", "He has taught in this school since 1950.", "He is teaching in this school since 1950.", "He taught in this school since 1950."], a: "He has taught in this school since 1950.", note: "æ•™å­¸ç¶“æ­·æŒçºŒã€‚" },
    { q: "It has been raining since two days ago.", opts: ["It has been raining since two days ago.", "It rained since two days ago.", "It is raining since two days ago.", "It was raining since two days ago."], a: "It has been raining since two days ago.", note: "ç¾åœ¨å®Œæˆé€²è¡Œå¼ã€‚" },
    { q: "He has studied English since he went to college.", opts: ["He has studied English since he went to college.", "He has studied English before he went to college.", "He studied English since he went to college.", "He is studying English since he went to college."], a: "He has studied English since he went to college.", note: "è‡ªå¤§å­¸èµ·å­¸ç¿’ã€‚" },
    { q: "I do not love music.", opts: ["I do not love music.", "I not love music.", "I am not love music.", "I don't loves music."], a: "I do not love music.", note: "ä¸€èˆ¬å‹•è©å¦å®šã€‚" },
    { q: "He does not walk to school.", opts: ["He is not walk to school.", "He does not walk to school.", "He not walks to school.", "He doesn't walks to school."], a: "He does not walk to school.", note: "ä¸‰å–®å¦å®š does notã€‚" },
    { q: "My brother does not go to school by bus.", opts: ["My brother do not go to school by bus.", "My brother does not go to school by bus.", "My brother not goes to school by bus.", "My brother is not go to school by bus."], a: "My brother does not go to school by bus.", note: "å–®æ•¸ä¸»è©ã€‚" },
    { q: "His brother is not my teacher.", opts: ["His brother is not my teacher.", "His brother not my teacher.", "His brother does not my teacher.", "His brother no is my teacher."], a: "His brother is not my teacher.", note: "B å‹•è©å¦å®šã€‚" },
    { q: "He was not happy yesterday.", opts: ["He was not happy yesterday.", "He not happy yesterday.", "He did not happy yesterday.", "He were not happy yesterday."], a: "He was not happy yesterday.", note: "éå»ç‹€æ…‹å¦å®šã€‚" },
    { q: "He did not eat breakfast yesterday morning.", opts: ["He does not eat breakfast yesterday morning.", "He did not eat breakfast yesterday morning.", "He not ate breakfast yesterday morning.", "He was not eat breakfast yesterday morning."], a: "He did not eat breakfast yesterday morning.", note: "æ˜¨æ™¨å‹•ä½œå¦å®šã€‚" },
    { q: "He is not my teacher.", opts: ["He is not my teacher.", "He does not my teacher.", "He not my teacher.", "He no be my teacher."], a: "He is not my teacher.", note: "B å‹•è©å¦å®šã€‚" },
    { q: "My father does not swim every day.", opts: ["My father is not swim every day.", "My father does not swim every day.", "My father not swims every day.", "My father no swim every day."], a: "My father does not swim every day.", note: "ä¸€èˆ¬å‹•è©å¦å®šã€‚" },
    { q: "He did not go to school yesterday because he was sick.", opts: ["He did not go to school yesterday because he was sick.", "He was not go too school yesterday because he was sick.", "He does not go to school yesterday because he was sick.", "He not goes to school yesterday because he was sick."], a: "He did not go to school yesterday because he was sick.", note: "æ™‚æ…‹ä¸€è‡´ã€‚" },
    { q: "He did not see that movie last night.", opts: ["He did not see that movie last night.", "He does not see that movie last night.", "He was not see that movie last night.", "He not saw that movie last night."], a: "He did not see that movie last night.", note: "æ˜¨æ™šæ²’çœ‹ã€‚" },
    { q: "Do you love music?", opts: ["Are you love music?", "Do you love music?", "Is you love music?", "Does you love music?"], a: "Do you love music?", note: "å‹•è©å•å¥ç”¨ Doã€‚" },
    { q: "Are you a student?", opts: ["Are you a student?", "Do you a student?", "Is you a student?", "You are a student?"], a: "Are you a student?", note: "B å‹•è©å•å¥ã€‚" },
    { q: "Does he work as a fisherman?", opts: ["Is he work as a fisherman?", "Does he work as a fisherman?", "Do he work as a fisherman?", "Is he working as a fisherman?"], a: "Does he work as a fisherman?", note: "è·æ¥­ç¿’æ…£å•å¥ã€‚" },
    { q: "Did he go to the church yesterday?", opts: ["Does he go to the church yesterday?", "Did he go to the church yesterday?", "Is he go to the church yesterday?", "Was he go to the church yesterday?"], a: "Did he go to the church yesterday?", note: "æ˜¨æ—¥å•å¥ç”¨ Didã€‚" }
];

let userData = JSON.parse(localStorage.getItem('kana_v3')) || { mastered: 0, currentLevel: 0, failed_list: [], stickers: [] };
let currentGroup = [];
let totalInGroup = 20;
let isLocked = false;
let isRetryMode = false;

function init() {
    document.getElementById('mastered-count').innerText = userData.mastered;
    document.getElementById('lv-display').innerText = userData.currentLevel + 1;
    document.getElementById('failed-count').innerText = userData.failed_list.length;
    document.getElementById('sticker-count').innerText = userData.stickers.length;
    if (userData.failed_list.length > 0) document.getElementById('retry-btn').classList.remove('hidden');
}

function startLevel() {
    isRetryMode = false;
    const startIdx = userData.currentLevel * 20;
    const group = allQuestions.slice(startIdx, startIdx + 20);
    if (group.length === 0) return alert("é¡Œåº«å·²æ¸…ç©ºæï¼");
    currentGroup = shuffle([...group]);
    totalInGroup = currentGroup.length;
    showGame();
}

function startRetry() {
    isRetryMode = true;
    currentGroup = shuffle([...userData.failed_list]);
    totalInGroup = currentGroup.length;
    showGame();
}

function showGame() {
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('game-zone').classList.remove('hidden');
    document.getElementById('home-icon').classList.remove('hidden');
    document.getElementById('total-num').innerText = totalInGroup;
    renderQuestion();
}

function renderQuestion() {
    isLocked = false;
    if (currentGroup.length === 0) return handleFinish();
    const data = currentGroup[0];
    document.getElementById('q-text').innerText = data.q;
    document.getElementById('hint-text').innerText = data.note;
    document.getElementById('hint-area').classList.add('hidden');
    const area = document.getElementById('choices-area');
    area.innerHTML = "";
    data.opts.forEach(opt => {
        const b = document.createElement('button');
        b.className = "btn-choice"; b.innerText = opt;
        b.onclick = () => handleSelect(opt, b);
        area.appendChild(b);
    });
    const solved = totalInGroup - currentGroup.length;
    const p = (solved/totalInGroup)*100;
    document.getElementById('progress-bar').style.width = p + "%";
    document.getElementById('piske-img').style.left = p + "%";
    document.getElementById('progress-num').innerText = solved;
}

function handleSelect(opt, b) {
    if (isLocked) return; isLocked = true;
    const cur = currentGroup[0];
    if (opt === cur.a) {
        b.classList.add('choice-correct-mint');
        if (!isRetryMode) userData.mastered++;
        else userData.failed_list = userData.failed_list.filter(i => i.q !== cur.q);
        setTimeout(() => { currentGroup.shift(); saveData(); renderQuestion(); }, 800);
    } else {
        document.querySelectorAll('.btn-choice').forEach(btn => { if(btn.innerText === cur.a) btn.classList.add('choice-reveal-pink'); });
        if (!isRetryMode && !userData.failed_list.some(i => i.q === cur.q)) userData.failed_list.push(cur);
        document.getElementById('hint-area').classList.remove('hidden');
        setTimeout(() => { currentGroup.push(currentGroup.shift()); renderQuestion(); }, 2000);
    }
}

function handleFinish() {
    document.getElementById('game-zone').classList.add('hidden');
    document.getElementById('finish-zone').classList.remove('hidden');
    if (!isRetryMode) {
        const stickerIdx = userData.currentLevel;
        if (stickerIdx < STICKERS.length && !userData.stickers.includes(stickerIdx)) {
            userData.stickers.push(stickerIdx);
            document.getElementById('new-sticker-alert').classList.remove('hidden');
            document.getElementById('unlocked-img').src = STICKERS[stickerIdx];
        }
        userData.currentLevel++;
    }
    saveData();
}

function showBook() {
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('book-zone').classList.remove('hidden');
    const grid = document.getElementById('sticker-grid');
    grid.innerHTML = "";
    STICKERS.forEach((url, i) => {
        const div = document.createElement('div');
        div.className = "sticker-item" + (userData.stickers.includes(i) ? " unlocked" : "");
        div.innerHTML = `<img src="${url}">`;
        grid.appendChild(div);
    });
}

function goHome() { location.reload(); }
function saveData() { localStorage.setItem('kana_v3', JSON.stringify(userData)); }
function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }
function resetGame() { if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
init();
</script>
</body>
</html>
