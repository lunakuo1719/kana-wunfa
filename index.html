<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>æ–‡æ³•è¨ä¼åœ˜~æï¼</title>
    <style>
        :root {
            --kanahei-pink: #fce4ec; 
            --kanahei-rose: #f06292; 
            --kanahei-brown: #6d4c41; 
            --kanahei-cream: #fff9c4; 
        }

        * { box-sizing: border-box; font-family: 'Arial', sans-serif; font-weight: 900; -webkit-tap-highlight-color: transparent; }

        body { margin: 0; padding: 10px; background-color: var(--kanahei-pink); display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }

        .card {
            width: 100%; max-width: 480px; background: white;
            border: 5px solid var(--kanahei-brown);
            border-radius: 40px; padding: 25px;
            box-shadow: 0px 10px 0px var(--kanahei-rose);
            position: relative; text-align: center;
            z-index: 10;
        }

        .header-gifs { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; padding: 0 5px; }
        .header-gifs img { width: 30%; height: auto; }
        .header-gifs img:nth-child(2) { width: 38%; transform: translateY(-5px); }

        #feedback-overlay {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 999; display: none; pointer-events: none;
        }
        #feedback-overlay img { width: 220px; filter: drop-shadow(0 0 15px white); }

        /* é€²åº¦æ¢èˆ‡æ–‡å­— */
        .progress-info { display: flex; justify-content: space-between; font-size: 16px; color: var(--kanahei-brown); margin-bottom: 5px; padding: 0 5px; }
        .progress-container { margin: 10px 0 25px 0; position: relative; height: 60px; }
        .piske-runner { position: absolute; bottom: 15px; width: 65px; transition: left 0.3s; margin-left: -32px; z-index: 5; }
        .bar-outer { height: 16px; background: var(--kanahei-cream); border: 3px solid var(--kanahei-brown); border-radius: 10px; overflow: hidden; }
        .bar-inner { height: 100%; width: 0%; background: var(--kanahei-rose); transition: width 0.3s; }

        .q-box { font-size: 24px; color: var(--kanahei-brown); margin: 20px 0; text-align: left; line-height: 1.5; min-height: 60px; }
        
        .btn-choice { 
            background: white; margin-bottom: 15px; font-size: 22px; 
            border: 3px solid var(--kanahei-brown); border-radius: 20px; 
            width: 100%; padding: 20px; text-align: left; cursor: pointer; color: var(--kanahei-brown);
            box-shadow: 0 5px 0 #ddd; transition: 0.1s;
        }
        .btn-choice:active { transform: translateY(3px); box-shadow: none; }

        .main-btn { 
            width: 90%; padding: 18px; font-size: 24px; border-radius: 35px; 
            background: var(--kanahei-rose); color: white; border: 4px solid var(--kanahei-brown); 
            cursor: pointer; box-shadow: 0 6px 0 var(--kanahei-brown); margin: 12px 0;
        }

        .translation-box { 
            background: #fff9c4; padding: 18px; border-radius: 20px; 
            margin-top: 15px; font-size: 19px; border: 3px dashed var(--kanahei-rose); 
            color: #d81b60; text-align: left;
        }

        /* æ„›å¿ƒé›¨åœ–ç‰‡æ¨£å¼ */
        .heart {
            position: fixed; top: -15%; 
            user-select: none; z-index: 100;
            animation: fall linear forwards;
            pointer-events: none;
        }
        @keyframes fall {
            to { transform: translateY(115vh) rotate(360deg); }
        }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="feedback-overlay"><img id="feedback-img" src=""></div>

<div class="card">
    <div id="dashboard">
        <div class="header-gifs">
            <img src="https://lunakuo1719.github.io/kana-wunfa/heade-M.gif">
            <img src="https://lunakuo1719.github.io/kana-wunfa/xmas.gif">
            <img src="https://lunakuo1719.github.io/kana-wunfa/heade_r.gif">
        </div>
        <h1 style="color: var(--kanahei-rose); margin:5px 0; font-size: 28px;">æ–‡æ³•è¨ä¼åœ˜~æï¼</h1>
        
        <div style="background: var(--kanahei-cream); padding: 18px; border-radius: 25px; border: 3px solid var(--kanahei-brown); margin: 20px 0;">
            <p style="font-size:20px; margin:8px 0;">å·²ç†Ÿç·´ï¼š<span id="mastered-count" style="color:var(--kanahei-rose)">0</span></p>
            <p style="font-size:20px; margin:8px 0;">éŒ¯é¡Œæ•¸ï¼š<span id="failed-count">0</span> | è²¼ç´™ï¼š<span id="sticker-count">0</span>/17</p>
        </div>

        <button class="main-btn" onclick="startLevel()">é–‹å§‹è¨ä¼ï¼</button>
        <button id="retry-btn" class="main-btn" style="background:#b2cecf; display:none;" onclick="startRetry()">éŒ¯é¡Œè£œè€ƒ</button>
        <button class="main-btn" style="background:#ffd54f;" onclick="alert('æ”¶é›†å†Šå³å°‡é–‹æ”¾ï¼')">æˆ‘çš„æ”¶é›†å†Š</button>
    </div>

    <div id="game-zone" class="hidden">
        <div class="progress-info">
            <span>æ­£åœ¨æ”»ç•¥ä¸­...æï¼</span>
            <span>é€²åº¦ï¼š<span id="progress-num">0</span> / <span id="total-num">20</span></span>
        </div>
        <div class="progress-container">
            <img id="piske-img" src="https://lunakuo1719.github.io/kana-wunfa/glasskar.gif" class="piske-runner">
            <div class="bar-outer"><div class="bar-inner" id="progress-bar"></div></div>
        </div>
        
        <div id="q-text" class="q-box"></div>
        <div id="choices-area"></div>
        
        <div id="hint-area" class="translation-box hidden">
            <strong>ğŸ’¡ ä¸­æ–‡ç¿»è­¯ï¼š</strong><br><span id="hint-text"></span>
        </div>
    </div>
</div>

<script>
const IMG_YES = "https://lunakuo1719.github.io/kana-wunfa/heartna.gif";
const IMG_WRONG = "https://lunakuo1719.github.io/kana-wunfa/Wrong.gif";
const RAIN_IMAGE = "https://lunakuo1719.github.io/kana-wunfa/nahappy.gif";

const allQuestions = [
    { q: "He is devoted _______ his work.", opts: ["to", "at", "in", "on"], a: "to", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–è‡´åŠ›æ–¼ä»–çš„å·¥ä½œã€‚" },
    { q: "What do you say _______ going for a walk?", opts: ["to", "for", "with", "about"], a: "to", note: "ä¸­æ–‡ç¿»è­¯ï¼šå»æ•£æ­¥ä½ è¦ºå¾—å¦‚ä½•ï¼Ÿ" },
    { q: "I am _______ of being alone.", opts: ["afraid", "scared", "fear", "frighten"], a: "afraid", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘æ€•å­¤å–®ã€‚" },
    { q: "He is _______ of his success.", opts: ["proud", "pride", "prouder", "proudly"], a: "proud", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–ç‚ºè‡ªå·±çš„æˆåŠŸæ„Ÿåˆ°é©•å‚²ã€‚" },
    { q: "This book belongs _______ me.", opts: ["with", "to", "for", "at"], a: "to", note: "ä¸­æ–‡ç¿»è­¯ï¼šé€™æœ¬æ›¸å±¬æ–¼æˆ‘ã€‚" },
    { q: "Compare this _______ that.", opts: ["with", "to", "at", "by"], a: "with", note: "ä¸­æ–‡ç¿»è­¯ï¼šæ‹¿é€™å€‹è·Ÿé‚£å€‹æ¯”è¼ƒã€‚" },
    { q: "He died _______ cancer.", opts: ["of", "from", "by", "with"], a: "of", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–æ­»æ–¼ç™Œç—‡ (die of ç—…å)ã€‚" },
    { q: "I agree _______ you.", opts: ["to", "with", "at", "on"], a: "with", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘åŒæ„ä½ ã€‚" },
    { q: "The chair is made _______ wood.", opts: ["of", "from", "by", "with"], a: "of", note: "ä¸­æ–‡ç¿»è­¯ï¼šé€™æ¤…å­æ˜¯æœ¨é ­åšçš„ (ç‰©ç†è®ŠåŒ–ç”¨ of)ã€‚" },
    { q: "Wine is made _______ grapes.", opts: ["of", "from", "by", "with"], a: "from", note: "ä¸­æ–‡ç¿»è­¯ï¼šé…’æ˜¯è‘¡è„é‡€çš„ (åŒ–å­¸è®ŠåŒ–ç”¨ from)ã€‚" },
    { q: "He is independent _______ his parents.", opts: ["of", "from", "with", "at"], a: "of", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–ç¨ç«‹æ–¼çˆ¶æ¯ä¹‹å¤–ï¼ˆä¸ä¾è³´ï¼‰ã€‚" },
    { q: "I am familiar _______ this place.", opts: ["with", "to", "at", "in"], a: "with", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘å°é€™åœ°æ–¹å¾ˆç†Ÿæ‚‰ã€‚" },
    { q: "The place is familiar _______ me.", opts: ["with", "to", "at", "in"], a: "to", note: "ä¸­æ–‡ç¿»è­¯ï¼šé€™åœ°æ–¹å°æˆ‘ä¾†èªªå¾ˆç†Ÿæ‚‰ã€‚" },
    { q: "He is absent _______ school.", opts: ["from", "at", "in", "to"], a: "from", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–ä¸Šå­¸ç¼ºå¸­ã€‚" },
    { q: "Don't be late _______ class.", opts: ["for", "at", "in", "to"], a: "for", note: "ä¸­æ–‡ç¿»è­¯ï¼šä¸Šèª²åˆ¥é²åˆ°ã€‚" },
    { q: "This is the place _______ I was born.", opts: ["which", "where", "that", "at"], a: "where", note: "ä¸­æ–‡ç¿»è­¯ï¼šé€™æ˜¯æˆ‘å‡ºç”Ÿçš„åœ°æ–¹ã€‚" },
    { q: "This is the house _______ I bought.", opts: ["which", "where", "that", "whose"], a: "which", note: "ä¸­æ–‡ç¿»è­¯ï¼šé€™æ˜¯æˆ‘è²·çš„æˆ¿å­ã€‚" },
    { q: "Choose the correct sentence:", opts: ["I like to play the piano.", "I like play the piano.", "I am like to play the piano.", "I like playing the piano."], a: "I like to play the piano.", note: "1-1ï¼šlike å¾Œæ¥ to V æˆ– Ving [cite: 2, 38]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["He swim every day.", "He swims every day.", "He is swim every day.", "He swimming every day."], a: "He swims every day.", note: "1-2ï¼šç¬¬ä¸‰äººç¨±å–®æ•¸ç¿’æ…£æ€§å‹•ä½œï¼Œå‹•è©åŠ  s [cite: 2, 42]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["I not his student.", "I am not his student.", "I don't his student.", "I no be his student."], a: "I am not his student.", note: "1-3ï¼šB å‹•è©å¦å®šå¥çµæ§‹ [cite: 2, 45]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["My father likes to play the violin.", "My father likes to playing violin.", "My father like to play the violin.", "My father is likes to play the violin."], a: "My father likes to play the violin.", note: "1-4ï¼šä¸å®šè© to ä¹‹å¾Œæ¥åŸå½¢å‹•è© [cite: 2, 47]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["He can swims.", "He can swim.", "He can to swim.", "He is can swim."], a: "He can swim.", note: "1-5ï¼šåŠ©å‹•è© can å¾Œæ¥åŸå½¢å‹•è© [cite: 2, 51]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["He hates eat fish.", "He hates to eat fish.", "He hate eat fish.", "He is hate to eat fish."], a: "He hates to eat fish.", note: "1-6ï¼šhate å¾Œæ¥ä¸å®šè© [cite: 2, 54]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["My father go to church every Sunday.", "My father goes to church every Sunday.", "My father is go to church every Sunday.", "My father going to church every Sunday."], a: "My father goes to church every Sunday.", note: "1-7ï¼šè¦å¾‹ç¿’æ…£ç”¨ç¾åœ¨ç°¡å–®å¼ï¼Œå–®æ•¸åŠ  s [cite: 2, 57]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["He does not love music.", "He do not live music.", "He is not love music.", "He not loves music."], a: "He does not love music.", note: "1-8ï¼šä¸€èˆ¬å‹•è©å¦å®šéœ€ç”¨åŠ©å‹•è© does [cite: 2, 59]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["He walks to work every day.", "He walks to works every day.", "He walk to work every day.", "He is walk to work every day."], a: "He walks to work every day.", note: "1-9ï¼šå–®æ•¸ä¸»è©å‹•è©è®ŠåŒ–åŠå›ºå®šç‰‡èª walk to work [cite: 2, 62]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["Can he to swim?", "Can he swim?", "Does he can swim?", "Can he swims?"], a: "Can he swim.", note: "1-10ï¼šåŠ©å‹•è©å•å¥çµæ§‹ [cite: 2, 66]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["I am walking to school every day.", "I walk to school every day.", "I walks to school every day.", "I am walk to school every day."], a: "I walk to school every day.", note: "1-11ï¼šç¿’æ…£æ€§å‹•ä½œä¸ä½¿ç”¨é€²è¡Œå¼ [cite: 3, 69]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["I watch TV now.", "I am watching TV now.", "I watching TV now.", "I am watch TV now."], a: "I am watching TV now.", note: "1-12ï¼šnow æç¤ºç¾åœ¨é€²è¡Œå¼ [cite: 3, 72]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["He calls his father every day.", "He is calling his father every day.", "He call his father every day.", "He calling his father every day."], a: "He calls his father every day.", note: "1-13ï¼šæ¯æ—¥ç¿’æ…£ç”¨ç¾åœ¨ç°¡å–®å¼ [cite: 3, 74]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["He is taking a walk in the morning every day.", "He takes a walk in the morning every day.", "He take a walk in the morning every day.", "He is take a walk every day."], a: "He takes a walk in the morning every day.", note: "1-14ï¼šè¦å¾‹æ™¨é–“æ•£æ­¥ç”¨ç°¡å–®å¼ [cite: 3, 78]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["He is playing the piano now.", "He plays the piano now.", "He playing the piano now.", "He is play the piano now."], a: "He is playing the piano now.", note: "1-15ï¼šæ­£åœ¨å½ˆé‹¼ç´ [cite: 3, 80]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["He is reading a book now.", "He reads a book now.", "He reading a book now.", "He is read a book now."], a: "He is reading a book now.", note: "1-16ï¼šæ­£åœ¨é–±è®€ [cite: 3, 83]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["He swims every morning.", "He is swimming every morning.", "He swim every morning.", "He swimming every morning."], a: "He swims every morning.", note: "1-17ï¼šç¿’æ…£æ€§æ™¨æ³³ [cite: 3, 86]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["He is writing a letter at present.", "He writing a letter at present.", "He writes a letter at present.", "He is write a letter at present."], a: "He is writing a letter at present.", note: "1-18ï¼šat present ç”¨é€²è¡Œå¼ [cite: 3, 89]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["He talks to his mother now.", "He is talking to his mother now.", "He talking to his mother now.", "He talk to his mother now."], a: "He is talking to his mother now.", note: "1-19ï¼šå¼·èª¿ã€Œç¾åœ¨ã€æ­£åœ¨é€šè©± [cite: 3, 93]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["I am swim every day.", "I swim every day.", "I swimming every day.", "I am swimming every day."], a: "I swim every day.", note: "1-20ï¼šI æ­é…åŸå½¢å‹•è©è¡¨ç¤ºç¿’æ…£ [cite: 3, 96]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["I walked to school when I was a kid.", "I walk to school when I was a kid.", "I was walk to school when I was a kid.", "I had walk to school when I was a kid."], a: "I walked to school when I was a kid.", note: "1-21ï¼šéå»ç™¼ç”Ÿçš„ç¿’æ…£ï¼Œå‹•è©ç”¨éå»å¼ [cite: 4, 98]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["I eat two eggs in the morning today.", "I ate two eggs in the morning today.", "I am eat two eggs in the morning today.", "I eaten two eggs in the morning today."], a: "I ate two eggs in the morning today.", note: "1-22ï¼šå·²å®Œæˆçš„å‹•ä½œï¼ˆåƒéäº†ï¼‰ç”¨éå»å¼ [cite: 4, 102]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["I do not like music when I was young.", "I did not like music when I was young.", "I am not like music when I was young.", "I not liked music when I was young."], a: "I did not like music when I was young.", note: "1-23ï¼šéå»çš„å¦å®šç”¨ did not [cite: 4, 105]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["I do not go home yesterday.", "I did not go home yesterday.", "I am not go home yesterday.", "I was not go home yesterday."], a: "I did not go home yesterday.", note: "1-24ï¼šæ˜¨å¤©æ²’å›å®¶ï¼Œç”¨ did not + åŸå½¢ [cite: 4, 108]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["He is already very good in playing piano when he was six.", "He was already very good at playing piano when he was six.", "He is already very good at playing piano when he was six.", "He was already very good in playing piano when he was six."], a: "He was already very good at playing piano when he was six.", note: "1-25ï¼šbe good at ç‚ºå›ºå®šç”¨æ³•ï¼Œä¸”æ™‚æ…‹é ˆä¸€è‡´ [cite: 4, 111]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["They were my students five years ago.", "They are my students five years ago.", "They been my students five years ago.", "They was my students five years ago."], a: "They were my students five years ago.", note: "1-26ï¼šè¤‡æ•¸éå»å¼ B å‹•è©ç”¨ were [cite: 4, 113]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["Did you go to the church last Sunday?", "Do you go the church last Sunday?", "Are you go to the church last Sunday?", "Were you go to the church last Sunday?"], a: "Did you go to the church last Sunday?", note: "1-27ï¼šéå»æ™‚é–“çš„å•å¥ç”¨ Did [cite: 4, 116]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["I am very sad when I heard the bad news yesterday.", "I was very sad when I heard the bad news yesterday.", "I very sad when I heard the bad news yesterday.", "I am been very sad when I heard the news yesterday."], a: "I was very sad when I heard the bad news yesterday.", note: "1-28ï¼šç•¶æ™‚æ„Ÿåˆ°æ‚²å‚·ï¼Œæ™‚æ…‹éœ€å‰å¾Œä¸€è‡´ [cite: 4, 119]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["He does not know how to swim when he was a kid.", "He did not know how to swim when he was a kid.", "He not know how to swim when he was a kid.", "He is not know how to swim when he was a kid."], a: "He did not know how to swim when he was a kid.", note: "1-29ï¼šæè¿°å°æ™‚å€™ä¸å…·å‚™çš„èƒ½åŠ›ç”¨ past tense [cite: 4, 123]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["The earth goes around the sun.", "The earth went around the sun.", "The earth is go around the sun.", "The earth going around the sun."], a: "The earth goes around the sun.", note: "1-30ï¼šçœŸç†ã€äº‹å¯¦æ†ç”¨ç¾åœ¨ç°¡å–®å¼ [cite: 4, 125]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["When you came to my house, I am calling my father.", "When you came to my house, I was calling my father.", "When you come to my house, I was calling my father.", "When you came to my house, I called my father."], a: "When you came to my house, I was calling my father.", note: "1-31ï¼šéå»æŸå‹•ä½œç™¼ç”Ÿæ™‚ï¼Œå¦ä¸€å‹•ä½œæ­£åœ¨é€²è¡Œ [cite: 5, 129]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["I could not answer you because I am taking a shower.", "I could not answer you because I was taking a shower.", "I cannot answer you because I was taking a shower.", "I could not answer you because I taken a shower."], a: "I could not answer you because I was taking a shower.", note: "1-32ï¼šæè¿°ç•¶æ™‚æ­£åœ¨æ´—æ¾¡ï¼Œæ‰€ä»¥æ²’æ¥é›»è©± [cite: 5, 134]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["When the train reached the station, people are dancing there.", "When the train reached the station, people were dancing there.", "When the train reach the station, people were dancing there.", "When the train reached the station, people danced there."], a: "When the train reached the station, people were dancing there.", note: "1-33ï¼šéå»é€²è¡Œä¸­çš„èƒŒæ™¯å‹•ä½œ [cite: 5, 137]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["When you called me last night, I watched TV.", "When you called me last night, I was watching TV.", "When you call me last night, I am watching TV.", "When you called me last night, I watching TV."], a: "When you called me last night, I was watching TV.", note: "1-34ï¼šå¼·èª¿ç•¶æ™‚ã€Œæ­£åœ¨çœ‹é›»è¦–ã€ [cite: 5, 141]ã€‚" },
    { q: "Choose the correct sentence:", opts: ["My mother always cooked when I went home.", "My mother was always cooking when I went home.", "My mother always cook when I went home.", "My mother is always cooking when I went home."], a: "My mother was always cooking when I went home.", note: "1-35ï¼šéå»ç¿’æ…£æ€§æ­£åœ¨ç™¼ç”Ÿçš„å‹•ä½œ [cite: 5, 143]ã€‚" },
];

let userData = JSON.parse(localStorage.getItem('kana_v6')) || { mastered: 0, currentLevel: 0, failed_list: [], stickers: [] };
let currentGroup = [];
let totalInGroup = 20;
let isLocked = false;
let isRetryMode = false;

function init() {
    document.getElementById('mastered-count').innerText = userData.mastered;
    document.getElementById('failed-count').innerText = userData.failed_list.length;
    document.getElementById('sticker-count').innerText = userData.stickers.length;
    document.getElementById('retry-btn').style.display = userData.failed_list.length > 0 ? "inline-block" : "none";
}

function startLevel() {
    isRetryMode = false;
    const startIdx = (userData.currentLevel % 5) * 20;
    currentGroup = allQuestions.slice(startIdx, startIdx + 20).sort(() => Math.random() - 0.5);
    setupGame();
}

function startRetry() {
    isRetryMode = true;
    currentGroup = [...userData.failed_list].sort(() => Math.random() - 0.5);
    setupGame();
}

function setupGame() {
    totalInGroup = currentGroup.length;
    document.getElementById('total-num').innerText = totalInGroup;
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('game-zone').classList.remove('hidden');
    renderQuestion();
}

function renderQuestion() {
    isLocked = false;
    if (currentGroup.length === 0) return finishLevel();
    
    const data = currentGroup[0];
    document.getElementById('q-text').innerText = data.q;
    document.getElementById('hint-text').innerText = data.note;
    document.getElementById('hint-area').classList.add('hidden');
    
    const area = document.getElementById('choices-area');
    area.innerHTML = "";
    data.opts.forEach(opt => {
        const b = document.createElement('button');
        b.className = "btn-choice";
        b.innerText = opt;
        b.onclick = () => handleSelect(opt, b);
        area.appendChild(b);
    });

    const solved = totalInGroup - currentGroup.length;
    document.getElementById('progress-num').innerText = solved;
    const p = (solved/totalInGroup)*100;
    document.getElementById('progress-bar').style.width = p + "%";
    document.getElementById('piske-img').style.left = p + "%";
}

function handleSelect(opt, b) {
    if (isLocked) return;
    isLocked = true;
    const cur = currentGroup[0];
    const overlay = document.getElementById('feedback-overlay');
    const fImg = document.getElementById('feedback-img');

    document.getElementById('hint-area').classList.remove('hidden');

    if (opt === cur.a) {
        fImg.src = IMG_YES + "?t=" + Date.now();
        overlay.style.display = "block";
        b.style.background = "#b2cecf";
        
        if (isRetryMode) {
            userData.failed_list = userData.failed_list.filter(q => q.q !== cur.q);
        } else {
            userData.mastered++;
        }

        setTimeout(() => {
            overlay.style.display = "none";
            currentGroup.shift();
            saveData();
            renderQuestion();
        }, 1800);
    } else {
        fImg.src = IMG_WRONG + "?t=" + Date.now();
        overlay.style.display = "block";
        b.style.background = "#f06292";
        b.style.color = "white";

        if (!isRetryMode && !userData.failed_list.some(q => q.q === cur.q)) {
            userData.failed_list.push(cur);
        }

        setTimeout(() => {
            overlay.style.display = "none";
            currentGroup.push(currentGroup.shift());
            renderQuestion();
        }, 2200);
    }
}

function finishLevel() {
    startHeartRain(); // å‘¼å«ä¸‹æ–¹çš„æ„›å¿ƒé›¨
    setTimeout(() => {
        if (!isRetryMode) userData.currentLevel++;
        saveData();
        alert(isRetryMode ? "è£œè€ƒéé—œæï¼" : "æ”»ç•¥æˆåŠŸï¼é€å¦³æ»¿æ»¿é©šå–œï¼");
        location.reload();
    }, 3500);
}

// ğŸŒ¸ ç²‰ç´…æ„›å¿ƒé›¨ (nahappy.gif ç‰ˆ)
function startHeartRain() {
    for (let i = 0; i < 40; i++) {
        setTimeout(() => {
            const heart = document.createElement('img');
            heart.className = 'heart';
            heart.src = RAIN_IMAGE;
            
            // éš¨æ©Ÿå·¦é‚Šä½ç½®
            heart.style.left = Math.random() * 100 + 'vw';
            // éš¨æ©Ÿå¤§å° (40px ~ 90px)
            const size = Math.random() * 50 + 40;
            heart.style.width = size + 'px';
            // éš¨æ©Ÿæ‰è½é€Ÿåº¦ (2s ~ 4s)
            heart.style.animationDuration = (Math.random() * 2 + 2) + 's';
            // éš¨æ©Ÿé€æ˜åº¦
            heart.style.opacity = Math.random() * 0.4 + 0.6; 
            
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 4000);
        }, i * 150);
    }
}

function saveData() { localStorage.setItem('kana_v6', JSON.stringify(userData)); }
init();
</script>
</body>
</html>
